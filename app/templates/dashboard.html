<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Command â€” MEEHAN Design</title>
    <link rel="icon" type="image/jpeg" href="/static/images/favicon16x16.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Antonio:wght@400;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        @keyframes scan{0%{top:-2px}100%{top:100%}}
        @keyframes pulse{0%,100%{opacity:.7}50%{opacity:1}}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        @keyframes pulseRing{0%{r:22;opacity:.5}100%{r:40;opacity:0}}
        @keyframes redAlert{0%,100%{opacity:0}50%{opacity:.15}}

        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

        :root{
            --gold:#f1a727;--orange:#ff9900;--peach:#ffcc99;
            --blue:#9999ff;--ltblue:#aaccff;--purple:#cc99cc;
            --red:#cc4444;--green:#55ff55;--cyan:#88ddff;
            --dkblue:#4455ff;--bg:#000;--panel:#111;
            --text:#ff9900;
            --heading:Antonio,Orbitron,sans-serif;
        }

        body{background:var(--bg);color:var(--text);font-family:var(--heading);overflow:hidden;height:100vh;width:100vw}

        /* Scan line */
        .scanline{position:fixed;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(255,153,0,.1),transparent);animation:scan 4s linear infinite;pointer-events:none;z-index:9999}

        /* Red Alert */
        .red-alert-overlay{position:fixed;inset:0;background:red;animation:redAlert 1s ease infinite;pointer-events:none;z-index:9998;display:none}
        body.red-alert .red-alert-overlay{display:block}

        /* TOP HEADER */
        .meehan-header{display:flex;align-items:stretch;height:60px;gap:4px;padding:0 4px}
        .meehan-header .elbow-tl{width:160px;min-width:160px;background:var(--gold);border-radius:0 0 0 40px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#000;font-weight:700;letter-spacing:2px}
        .meehan-header .bar-top{flex:1;background:var(--gold);display:flex;align-items:center;padding:0 20px;gap:30px}
        .meehan-header .bar-top .title{font-size:28px;font-weight:700;color:#000;letter-spacing:4px;text-transform:uppercase}
        .meehan-header .bar-top .status-items{display:flex;gap:25px;margin-left:auto;align-items:center}
        .meehan-header .bar-top .status-item{font-size:12px;color:#000;font-weight:700;letter-spacing:1px}
        .meehan-header .bar-top .status-item .val{font-size:16px;margin-left:4px}
        .meehan-header .elbow-tr{width:80px;min-width:80px;background:var(--peach);border-radius:0 0 40px 0}

        /* MAIN LAYOUT */
        .meehan-main{display:flex;height:calc(100vh - 64px);gap:4px;padding:4px}

        /* LEFT SIDEBAR */
        .meehan-sidebar{width:160px;min-width:160px;display:flex;flex-direction:column;gap:3px}
        .sidebar-block{padding:8px 12px;font-size:13px;font-weight:700;letter-spacing:2px;color:#000;cursor:pointer;text-transform:uppercase;transition:all .2s;text-align:right;min-height:38px;display:flex;align-items:center;justify-content:flex-end}
        .sidebar-block:hover{filter:brightness(1.3);transform:scale(1.02)}
        .sidebar-block.active{filter:brightness(1.5);box-shadow:0 0 15px rgba(255,255,255,.2)}
        .sidebar-block:nth-child(1){background:var(--gold);border-radius:20px 0 0 0;flex:0 0 50px}
        .sidebar-block:nth-child(2){background:var(--blue)}
        .sidebar-block:nth-child(3){background:var(--purple)}
        .sidebar-block:nth-child(4){background:var(--peach)}
        .sidebar-block:nth-child(5){background:var(--ltblue)}
        .sidebar-block:nth-child(6){background:var(--orange)}
        .sidebar-block:nth-child(7){background:var(--cyan);color:#000}
        .sidebar-block:nth-child(8){background:linear-gradient(135deg,#0066ff,#00ccff);color:#fff}
        .sidebar-block:nth-child(9){background:var(--red);flex:1;border-radius:0 0 0 20px;align-items:flex-start;padding-top:10px}

        /* CONTENT AREA */
        .meehan-content{flex:1;display:flex;flex-direction:column;gap:4px;overflow:hidden}

        .content-header{display:flex;height:32px;gap:4px}
        .content-header .ch-label{background:var(--blue);color:#000;padding:0 20px;font-size:14px;font-weight:700;letter-spacing:3px;display:flex;align-items:center;border-radius:0 0 0 16px;min-width:200px}
        .content-header .ch-bar{flex:1;background:var(--blue);opacity:.6}
        .content-header .ch-info{background:var(--purple);color:#000;padding:0 15px;font-size:12px;font-weight:700;display:flex;align-items:center;letter-spacing:2px;border-radius:0 0 16px 0}

        .content-body{flex:1;overflow-y:auto;overflow-x:hidden;padding:10px;scrollbar-width:thin;scrollbar-color:var(--gold) #111}
        .content-body::-webkit-scrollbar{width:6px}
        .content-body::-webkit-scrollbar-track{background:#111}
        .content-body::-webkit-scrollbar-thumb{background:var(--gold);border-radius:3px}

        .view-panel{display:none}
        .view-panel.active{display:block;animation:fadeIn .3s ease}

        .content-footer{display:flex;height:24px;gap:4px}
        .content-footer .bf-left{background:var(--peach);width:200px;border-radius:12px 0 0 0}
        .content-footer .bf-mid{flex:1;background:var(--peach);opacity:.5;display:flex;align-items:center;justify-content:center;font-size:10px;color:#000;font-weight:700;letter-spacing:3px}
        .content-footer .bf-right{background:var(--gold);width:120px;border-radius:0 12px 0 0;display:flex;align-items:center;justify-content:center;font-size:10px;color:#000;font-weight:700}

        /* OVERVIEW */
        .overview-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-bottom:15px}
        .stat-card{background:#111;border:1px solid var(--gold);border-left:4px solid var(--gold);padding:15px}
        .stat-card .card-label{font-size:11px;letter-spacing:3px;color:var(--blue);margin-bottom:5px}
        .stat-card .card-value{font-size:36px;font-weight:700;color:var(--gold)}
        .stat-card .card-sub{font-size:11px;color:var(--peach);margin-top:3px}

        .device-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;margin-top:15px}
        .device-card{background:#0a0a1a;border:1px solid #333;padding:12px;display:flex;gap:12px;align-items:center;transition:all .2s;cursor:pointer}
        .device-card:hover{border-color:var(--gold);background:#111122}
        .dev-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
        .dev-icon.online{background:rgba(85,255,85,.15);border:2px solid var(--green)}
        .dev-icon.offline{background:rgba(204,68,68,.15);border:2px solid var(--red)}
        .dev-name{font-size:14px;color:var(--gold);font-weight:700}
        .dev-model{font-size:11px;color:#888}
        .dev-status{font-size:10px;margin-top:2px}
        .dev-status.online{color:var(--green)}
        .dev-status.offline{color:var(--red)}

        .section-title{font-size:16px;color:var(--blue);letter-spacing:4px;text-transform:uppercase;margin:20px 0 10px;padding-bottom:5px;border-bottom:2px solid var(--blue);opacity:.8}
        .section-title:first-child{margin-top:0}

        /* SCHEMATIC */
        .schematic-container,.topology-container{width:100%;height:calc(100vh - 180px);position:relative;overflow:hidden}
        .schematic-container svg,.topology-container svg{width:100%;height:100%}

        /* CLIENT ROW */
        .client-row{display:grid;grid-template-columns:40px 2fr 1fr 1fr 1fr 80px;gap:10px;align-items:center;padding:10px 15px;background:#0a0a1a;border-left:3px solid var(--blue);font-size:13px;transition:all .2s;margin-bottom:4px}
        .client-row:hover{background:#111133;border-left-color:var(--gold)}

        /* THREAT */
        .threat-panel{background:#0a0a1a;border:1px solid var(--red);border-left:4px solid var(--red);padding:15px;margin-bottom:10px}
        .threat-title{color:var(--red);font-size:14px;letter-spacing:2px;margin-bottom:8px}
        .threat-info{color:#999;font-size:13px}

        /* PULSE */
        .pulse-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
        .pulse-meter{background:#0a0a1a;border:1px solid var(--cyan);padding:15px;text-align:center}
        .pulse-meter .meter-label{font-size:11px;color:var(--cyan);letter-spacing:2px;margin-bottom:8px}
        .pulse-meter .meter-value{font-size:32px;color:var(--gold);font-weight:700}
        .pulse-meter .meter-bar{height:6px;background:#222;margin-top:10px;border-radius:3px;overflow:hidden}
        .pulse-meter .meter-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--gold));border-radius:3px;transition:width .5s}

        /* ===== MODERN STAR TREK UI ===== */
        .modern-wrapper{position:fixed;inset:0;background:#030812;z-index:10000;overflow:hidden;font-family:'Orbitron','Antonio',sans-serif;color:#c0d8f0}
        .modern-wrapper::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 30% 20%,rgba(0,100,255,.08) 0%,transparent 50%),radial-gradient(ellipse at 70% 80%,rgba(0,200,255,.05) 0%,transparent 50%),linear-gradient(0deg,rgba(0,150,255,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,150,255,.02) 1px,transparent 1px);background-size:100% 100%,100% 100%,40px 40px,40px 40px;pointer-events:none}
        .modern-topbar{height:56px;display:flex;align-items:center;padding:0 30px;border-bottom:1px solid rgba(0,150,255,.15);background:rgba(5,15,30,.9);backdrop-filter:blur(20px);position:relative;z-index:2}
        .modern-topbar .logo{font-size:18px;font-weight:900;letter-spacing:6px;color:#fff;text-transform:uppercase}
        .modern-topbar .logo span{color:#00aaff;font-weight:400}
        .modern-topbar .nav-pills{display:flex;gap:3px;margin-left:40px}
        .modern-topbar .nav-pill{padding:8px 18px;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:rgba(192,216,240,.5);cursor:pointer;transition:all .3s;border:1px solid transparent;border-radius:4px;font-family:'Orbitron',sans-serif}
        .modern-topbar .nav-pill:hover{color:#00aaff;border-color:rgba(0,170,255,.2);background:rgba(0,170,255,.05)}
        .modern-topbar .nav-pill.active{color:#00ccff;border-color:rgba(0,200,255,.3);background:rgba(0,200,255,.08)}
        .modern-topbar .status-bar{margin-left:auto;display:flex;gap:30px;align-items:center}
        .modern-topbar .status-badge{font-size:10px;letter-spacing:2px;color:rgba(192,216,240,.4)}
        .modern-topbar .status-badge .sv{color:#00ccff;font-size:13px;margin-left:5px;font-weight:700}
        .modern-topbar .status-badge .sv.warn{color:#ff6644}
        .modern-content{display:flex;height:calc(100vh - 84px);position:relative;z-index:2}
        .modern-rail{width:280px;border-right:1px solid rgba(0,150,255,.1);padding:20px;overflow-y:auto;background:rgba(5,12,25,.5)}
        .rail-card{background:rgba(0,100,255,.04);border:1px solid rgba(0,150,255,.1);border-radius:8px;padding:16px;margin-bottom:12px;transition:all .3s}
        .rail-card:hover{border-color:rgba(0,150,255,.25);background:rgba(0,100,255,.08)}
        .rail-card .rc-label{font-size:9px;letter-spacing:3px;color:rgba(192,216,240,.4);margin-bottom:6px;text-transform:uppercase}
        .rail-card .rc-value{font-size:32px;font-weight:700;color:#fff;line-height:1}
        .rail-card .rc-value.success{color:#00ee88}
        .rail-card .rc-value.danger{color:#ff5544}
        .rail-card .rc-value.info{color:#00aaff}
        .rail-card .rc-sub{font-size:10px;color:rgba(192,216,240,.3);margin-top:4px;letter-spacing:1px}
        .ring-container{display:flex;align-items:center;gap:15px;margin-top:8px}
        .ring-svg{width:50px;height:50px}
        .ring-bg{fill:none;stroke:rgba(0,150,255,.1);stroke-width:4}
        .ring-fg{fill:none;stroke:#00ccff;stroke-width:4;stroke-linecap:round}
        .modern-main{flex:1;padding:25px;overflow-y:auto}
        .holo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px}
        .holo-card{background:rgba(0,60,120,.06);border:1px solid rgba(0,150,255,.12);border-radius:12px;padding:20px;transition:all .4s;position:relative;overflow:hidden}
        .holo-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(0,200,255,.4),transparent);opacity:0;transition:opacity .4s}
        .holo-card:hover{border-color:rgba(0,200,255,.3);background:rgba(0,60,120,.12);transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,100,255,.1)}
        .holo-card:hover::before{opacity:1}
        .holo-card .hc-header{display:flex;align-items:center;gap:14px;margin-bottom:14px}
        .holo-card .hc-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
        .hc-icon.online{background:rgba(0,238,136,.1);border:1px solid rgba(0,238,136,.3)}
        .hc-icon.offline{background:rgba(255,85,68,.1);border:1px solid rgba(255,85,68,.3)}
        .holo-card .hc-name{font-size:15px;font-weight:700;color:#fff}
        .holo-card .hc-model{font-size:10px;color:rgba(192,216,240,.4);letter-spacing:1px}
        .holo-card .hc-status{font-size:11px;display:flex;align-items:center;gap:6px}
        .hc-status .dot{width:8px;height:8px;border-radius:50%}
        .hc-status .dot.on{background:#00ee88;box-shadow:0 0 10px #00ee88}
        .hc-status .dot.off{background:#ff5544;box-shadow:0 0 10px #ff5544;animation:blink 1.5s ease infinite}
        .holo-card .hc-details{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(0,150,255,.08)}
        .hc-detail-item .hcd-label{font-size:10px;color:rgba(192,216,240,.3);letter-spacing:1px;margin-bottom:2px}
        .hc-detail-item .hcd-value{font-size:10px;color:rgba(192,216,240,.7);font-family:monospace}
        .modern-section{font-size:11px;letter-spacing:5px;text-transform:uppercase;color:rgba(192,216,240,.3);margin:30px 0 15px;padding-bottom:8px;border-bottom:1px solid rgba(0,150,255,.08)}
        .modern-section:first-child{margin-top:0}
        .modern-back{position:absolute;bottom:50px;right:20px;background:rgba(0,100,255,.1);border:1px solid rgba(0,150,255,.2);color:#00aaff;padding:10px 25px;font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:3px;cursor:pointer;border-radius:6px;z-index:3;transition:all .3s}
        .modern-back:hover{background:rgba(0,100,255,.2);border-color:rgba(0,200,255,.4)}
        .modern-footer{position:absolute;bottom:0;left:0;right:0;height:28px;background:rgba(5,15,30,.95);border-top:1px solid rgba(0,150,255,.1);display:flex;align-items:center;padding:0 20px;font-size:9px;letter-spacing:3px;color:rgba(192,216,240,.2);z-index:3}
        .modern-footer .mf-dot{width:6px;height:6px;border-radius:50%;background:#00ee88;margin-right:8px;box-shadow:0 0 6px #00ee88}
    </style>
</head>
<body>
    <div class="scanline"></div>
    <div class="red-alert-overlay"></div>

    <!-- TOP HEADER -->
    <div class="meehan-header">
        <div class="elbow-tl" style="gap:6px;padding:0 10px"><img src="/static/images/firewire-logo.png" style="height:36px;filter:drop-shadow(0 0 3px rgba(241,167,39,.5))" onerror="this.style.display='none'"> FWN</div>
        <div class="bar-top">
            <div class="title">Network Command</div>
            <div class="status-items">
                <div class="status-item">GATEWAY <span class="val" id="hdr-gw">---</span></div>
                <div class="status-item">DEVICES <span class="val" id="hdr-dev">---</span></div>
                <div class="status-item">CLIENTS <span class="val" id="hdr-cli">---</span></div>
                <div class="status-item">STATUS <span class="val" id="hdr-status">SCANNING</span></div>
                <div class="status-item"><span class="val" id="hdr-stardate">---</span></div>
            </div>
        </div>
        <div class="elbow-tr"></div>
    </div>

    <!-- MAIN LAYOUT -->
    <div class="meehan-main">
        <div class="meehan-sidebar">
            <div class="sidebar-block active" data-view="overview" onclick="switchView('overview')">OVERVIEW</div>
            <div class="sidebar-block" data-view="deckplan" onclick="switchView('deckplan')">DECK PLAN</div>
            <div class="sidebar-block" data-view="topology" onclick="switchView('topology')">TOPOLOGY</div>
            <div class="sidebar-block" data-view="devices" onclick="switchView('devices')">DEVICES</div>
            <div class="sidebar-block" data-view="stalker" onclick="switchView('stalker')">WI-FI TRACK</div>
            <div class="sidebar-block" data-view="threats" onclick="switchView('threats')">THREAT WATCH</div>
            <div class="sidebar-block" data-view="pulse" onclick="switchView('pulse')">NET PULSE</div>
            <div class="sidebar-block" data-view="modern" onclick="switchView('modern')">MODERN UI</div>
            <div class="sidebar-block" data-view="settings" onclick="switchView('settings')">CONFIG</div>
            <div class="sidebar-block" data-view="credits" onclick="switchView('credits')">CREDITS</div>
        </div>

        <div class="meehan-content">
            <div class="content-header">
                <div class="ch-label" id="view-label">SYSTEM OVERVIEW</div>
                <div class="ch-bar"></div>
                <div class="ch-info" id="view-info">ACTIVE</div>
            </div>

            <div class="content-body">
                <div class="view-panel active" id="panel-overview"></div>
                <div class="view-panel" id="panel-deckplan"></div>
                <div class="view-panel" id="panel-topology"></div>
                <div class="view-panel" id="panel-devices"></div>
                <div class="view-panel" id="panel-stalker"></div>
                <div class="view-panel" id="panel-threats"></div>
                <div class="view-panel" id="panel-pulse"></div>
                <div class="view-panel" id="panel-modern"></div>
                <div class="view-panel" id="panel-settings"></div>
            <div id="panel-credits" class="content-panel" style="display:none"></div>
            </div>

            <div class="content-footer">
                <div class="bf-left"></div>
                <div class="bf-mid">FIREWIRE NETWORKS LTD \u2022 UNITED FEDERATION OF NETWORKS \u2022 M33HAN COMMAND \u2022 MEEHAN DESIGN v3.0</div>
                <div class="bf-right" id="footer-time">00:00:00</div>
            </div>
        </div>
    </div>

    <script>
    // ============ CORE ============
    let networkData = null;

    function switchView(view) {
        document.querySelectorAll('.sidebar-block').forEach(b => b.classList.remove('active'));
        document.querySelector('[data-view="' + view + '"]').classList.add('active');
        document.querySelectorAll('.view-panel').forEach(p => p.classList.remove('active'));
        document.getElementById('panel-' + view).classList.add('active');
        const labels = {
            overview:['SYSTEM OVERVIEW','ACTIVE'],deckplan:['VESSEL SCHEMATIC','DECK 1'],
            topology:['NETWORK TOPOLOGY','LIVE'],devices:['DEVICE REGISTRY','ALL SYSTEMS'],
            stalker:['WI-FI TRACKING','MONITORING'],threats:['THREAT ANALYSIS','SHIELDS UP'],
            pulse:['NETWORK PULSE','REAL-TIME'],modern:['MODERN INTERFACE','NEXT GEN'],settings:['CONFIGURATION','AUTHORIZED'],
            credits:['CREDITS & ATTRIBUTION','ACKNOWLEDGMENTS']
        };
        document.getElementById('view-label').textContent = labels[view][0];
        document.getElementById('view-info').textContent = labels[view][1];
        if (view === 'topology' && !document.getElementById('panel-topology').dataset.built) buildTopology();
        if (view === 'deckplan' && !document.getElementById('panel-deckplan').dataset.built) buildDeckPlan();
        if (view === 'modern') buildModernUI();
    }

    function getStardate() {
        const now = new Date();
        const d = String(now.getDate()).padStart(2,'0');
        const m = String(now.getMonth()+1).padStart(2,'0');
        const y = now.getFullYear();
        const hr = String(now.getHours()).padStart(2,'0');
        const mn = String(now.getMinutes()).padStart(2,'0');
        const sc = String(now.getSeconds()).padStart(2,'0');
        return d + '/' + m + '/' + y + ' ' + hr + ':' + mn + ':' + sc;
    }

    function formatUptime(seconds) {
        if (!seconds) return 'OFFLINE';
        const d = Math.floor(seconds / 86400);
        const h = Math.floor((seconds % 86400) / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        if (d > 0) return d + 'd ' + h + 'h ' + m + 'm';
        if (h > 0) return h + 'h ' + m + 'm';
        return m + 'm';
    }


    // Device image map - UniFi product images
    var DEVICE_IMAGES = {
        'UAP6MP': 'https://images.svc.ui.com/?u=https%3A%2F%2Fcdn.ecomm.ui.com%2Fproducts%2F25014856-9554-49e0-8e94-7e7e90890ca5%2F123fcc48-1767-4e9a-b498-6d9d66a7bba7.png&q=80&w=64',
        'U7LR': 'https://images.svc.ui.com/?u=https%3A%2F%2Fcdn.ecomm.ui.com%2Fproducts%2Fbec0c1bb-47da-4152-88a3-0780cfe2c0e8%2Fbf71e8a4-98df-46c6-b094-adc44eceb0b5.png&q=80&w=64',
        'U7MSH': 'https://images.svc.ui.com/?u=https%3A%2F%2Fcdn.ecomm.ui.com%2Fproducts%2Fe4136dff-4160-41e9-90ac-40ef3e73e70e%2F8f7dd9c5-5a9e-4131-8d1a-45fc9fed26d5.png&q=80&w=64',
        'UAPA6A9': 'https://images.svc.ui.com/?u=https%3A%2F%2Fcdn.ecomm.ui.com%2Fproducts%2F9e6db999-25ad-421f-b3c8-d44f3cbf1de5%2F86e98d3c-3ac0-4e64-a012-66e1da2a7c3c.png&q=80&w=64',
        'U7PG2': 'https://images.svc.ui.com/?u=https%3A%2F%2Fcdn.ecomm.ui.com%2Fproducts%2F41634a80-62c0-4c27-b80d-8f6e86fca17a%2F7e3dbba8-37d9-46e9-8e55-e1e9fb0a4e3e.png&q=80&w=64',
        'USPM16P': 'https://images.svc.ui.com/?u=https%3A%2F%2Fcdn.ecomm.ui.com%2Fproducts%2F0694226c-9791-4d7e-9fb1-d98c91fe3fda%2F2ae66f6d-f093-404a-a498-0aa1e3bf7842.png&q=80&w=64',
        'USF5P': 'https://images.svc.ui.com/?u=https%3A%2F%2Fcdn.ecomm.ui.com%2Fproducts%2Fdae7de3c-9843-429b-aff0-c2c735d6f07c%2F63b23c94-7891-4d73-bfee-5e7fbb3ff6b8.png&q=80&w=64',
        'USL16P': 'https://images.svc.ui.com/?u=https%3A%2F%2Fcdn.ecomm.ui.com%2Fproducts%2F1fc53c5d-0aca-4af8-945a-d54e4b0b09a1%2Fd52b6c2b-43fe-4f1c-85d3-2c1b6c7d2c72.png&q=80&w=64'
    };
    // Device full names
    var DEVICE_NAMES = {
        'UAP6MP': 'U6 Mesh Pro',
        'U7LR': 'UAP Long Range',
        'U7MSH': 'UAP AC Mesh',
        'UAPA6A9': 'U6+',
        'U7PG2': 'UAP AC Pro',
        'USPM16P': 'USW Pro Max 16 PoE',
        'USF5P': 'USW Flex',
        'USL16P': 'USW 16 PoE'
    };
    function getDeviceImg(model) {
      const imgMap = {
        'USPM16P': 'https://cdn.ecomm.ui.com/products/0694226c-9791-4d7e-9fb1-d98c91fe3fda/7b73b27e-e77a-4771-b6bf-0aed35b4a16e.png',
        'UAP6MP': 'https://cdn.ecomm.ui.com/products/34b89d08-9ac2-4e83-8d83-10ca6a7d83a9/f26e0cfe-585c-43b8-819e-dbf047578afd.png',
        'U7LR': 'https://cdn.ecomm.ui.com/products/350070a0-ae43-431b-b052-8e849c3b0a75/bad94693-bc54-4ab4-b060-9b972401941c.png',
        'USF5P': 'https://cdn.ecomm.ui.com/products/c9a07d37-b390-4a5b-89c5-3cdab8e011c7/4bcd3c2b-a8b1-4be1-baab-deda172291cd.png',
        'U7MSH': 'https://cdn.ecomm.ui.com/products/62cc30b7-9559-480f-9668-b9edf40c0772/f2010c22-ff34-48e5-81f4-e7dad275d3c0.png',
        'UAPA6A9': 'https://cdn.ecomm.ui.com/products/6d5c6141-e2e9-416a-b789-53e59416bb1a/853bc73b-f65b-4e59-a171-75c9a4a4615e.png',
        'USL16P': 'https://cdn.ecomm.ui.com/products/e726eace-a772-4f12-bfad-c68baf20e51f/9ecfc657-5e31-4135-89b5-46b3537b35fc.png',
        'U7PG2': 'https://cdn.ecomm.ui.com/products/fa8dd4e4-36c8-4c79-a928-22c7bff2ce29/ab5bc8a4-6135-402e-a695-e3ea5e16d3e6.png'
      };
      return imgMap[model] || null;
    }
    function getDeviceName(model) {
        return DEVICE_NAMES[model] || model;
    }

    setInterval(() => {
        const now = new Date();
        document.getElementById('footer-time').textContent = now.toLocaleTimeString('en-GB');
        document.getElementById('hdr-stardate').textContent = getStardate();
    }, 1000);
    document.getElementById('hdr-stardate').textContent = getStardate();

    // ============ LOAD DATA ============
    async function loadData() {
        try {
            const resp = await fetch('/api/system-status');
            const data = await resp.json();
            networkData = data;
            try {
                const [apResp, clientResp, healthResp] = await Promise.all([
                    fetch('/pulse/api/stats/aps'),
                    fetch('/pulse/api/stats/clients'),
                    fetch('/pulse/api/stats/health')
                ]);
                window._pulseAPs = await apResp.json();
                window._pulseClients = await clientResp.json();
                window._pulseHealth = await healthResp.json();
            } catch(pe) { console.log('Pulse API optional:', pe); }
            const sys = data.system;
            const devices = sys.devices || [];
            const online = devices.filter(d => d.state === 1).length;
            const offline = devices.filter(d => d.state !== 1).length;
            const aps = devices.filter(d => d.type === 'uap');
            const switches = devices.filter(d => d.type === 'usw');

            document.getElementById('hdr-gw').textContent = sys.gateway_model || 'N/A';
            document.getElementById('hdr-dev').textContent = devices.length;
            document.getElementById('hdr-cli').textContent = sys.num_clients || '0';
            document.getElementById('hdr-status').textContent = offline > 0 ? 'CAUTION' : 'NOMINAL';
            if (offline > 0) document.getElementById('hdr-status').style.color = '#cc4444';

            buildOverview(sys, devices, aps, switches, online, offline);
            buildDevices(devices);
            buildStalker(devices);
            buildThreats(sys);
            buildPulse(devices, sys);
            buildSettings();
            buildCredits();
            enhancePulseData();
        } catch(e) {
            document.getElementById('panel-overview').innerHTML = '<div style="color:var(--red);padding:40px;font-size:18px;">\u26A0 CONNECTION LOST<br><br><span style="font-size:13px;color:#888;">Unable to reach /api/system-status. Check your UniFi connection.<br><br><button onclick="location.reload()" style="background:var(--gold);color:#000;border:none;padding:10px 25px;font-family:var(--heading);font-weight:700;cursor:pointer;">RETRY</button></span></div>';
        }
    }

    // ============ BUILD OVERVIEW ============
    function buildOverview(sys, devices, aps, switches, online, offline) {
        document.getElementById('panel-overview').innerHTML =
            '<div class="overview-grid">' +
            '<div class="stat-card"><div class="card-label">TOTAL DEVICES</div><div class="card-value">' + devices.length + '</div><div class="card-sub">' + aps.length + ' ACCESS POINTS \u2022 ' + switches.length + ' SWITCHES</div></div>' +
            '<div class="stat-card" style="border-left-color:var(--green)"><div class="card-label">SYSTEMS ONLINE</div><div class="card-value" style="color:var(--green)">' + online + '</div><div class="card-sub">' + Math.round(online/devices.length*100) + '% OPERATIONAL</div></div>' +
            '<div class="stat-card" style="border-left-color:var(--red)"><div class="card-label">SYSTEMS OFFLINE</div><div class="card-value" style="color:var(--red)">' + offline + '</div><div class="card-sub">' + (offline > 0 ? 'REQUIRES ATTENTION' : 'ALL CLEAR') + '</div></div>' +
            '<div class="stat-card" style="border-left-color:var(--blue)"><div class="card-label">CONNECTED CLIENTS</div><div class="card-value" style="color:var(--blue)">' + (sys.num_clients||0) + '</div><div class="card-sub">ACROSS ' + aps.filter(a=>a.state===1).length + ' ACTIVE APs</div></div>' +
            '</div>' +
            '<div class="section-title">ACCESS POINTS</div><div class="device-grid">' +
            aps.map(d =>
                '<div class="device-card"><div class="dev-icon ' + (d.state===1?'online':'offline') + '">' + (getDeviceImg(d.model)?'<img src="'+getDeviceImg(d.model)+'" style="width:30px;height:30px;object-fit:contain" onerror="this.outerHTML=\'\uD83D\uDCE1\'">':'\uD83D\uDCE1') + '</div><div class="dev-info"><div class="dev-name">' + d.name + '</div><div class="dev-model">' + d.model + '</div><div class="dev-status ' + (d.state===1?'online':'offline') + '">\u25CF ' + (d.state===1?'ONLINE \u2014 '+formatUptime(d.uptime):'OFFLINE') + '</div></div></div>'
            ).join('') +
            '</div>' +
            '<div class="section-title">SWITCHES</div><div class="device-grid">' +
            switches.map(d =>
                '<div class="device-card"><div class="dev-icon ' + (d.state===1?'online':'offline') + '">' + (getDeviceImg(d.model)?'<img src="'+getDeviceImg(d.model)+'" style="width:30px;height:30px;object-fit:contain" onerror="this.outerHTML=\'\uD83D\uDD0C\'">':'\uD83D\uDD0C') + '</div><div class="dev-info"><div class="dev-name">' + d.name + '</div><div class="dev-model">' + d.model + '</div><div class="dev-status ' + (d.state===1?'online':'offline') + '">\u25CF ' + (d.state===1?'ONLINE \u2014 '+formatUptime(d.uptime):'OFFLINE') + '</div></div></div>'
            ).join('') +
            '</div>' +
            '<div class="section-title">SYSTEM DIAGNOSTICS</div><div class="overview-grid">' +
            '<div class="stat-card" style="border-left-color:var(--purple)"><div class="card-label">GATEWAY TYPE</div><div class="card-value" style="font-size:24px;color:var(--purple)">' + sys.gateway_model + '</div><div class="card-sub">CLOUD MANAGED</div></div>' +
            '<div class="stat-card" style="border-left-color:var(--cyan)"><div class="card-label">LONGEST UPTIME</div><div class="card-value" style="font-size:24px;color:var(--cyan)">' + formatUptime(Math.max(...devices.filter(d=>d.uptime).map(d=>d.uptime))) + '</div><div class="card-sub">MOST STABLE SYSTEM</div></div>' +
            '</div>';
    }

    // ============ BUILD DEVICES ============
    function buildDevices(devices) {
        document.getElementById('panel-devices').innerHTML =
            '<div class="section-title">DEVICE REGISTRY \u2014 ' + devices.length + ' UNITS</div>' +
            '<table style="width:100%;border-collapse:collapse;font-size:13px"><thead><tr style="border-bottom:2px solid var(--gold)">' +
            '<th style="text-align:left;padding:8px;color:var(--gold);letter-spacing:2px;font-size:11px">STATUS</th>' +
            '<th style="text-align:left;padding:8px;color:var(--gold);letter-spacing:2px;font-size:11px">DESIGNATION</th>' +
            '<th style="text-align:left;padding:8px;color:var(--gold);letter-spacing:2px;font-size:11px">MODEL</th>' +
            '<th style="text-align:left;padding:8px;color:var(--gold);letter-spacing:2px;font-size:11px">TYPE</th>' +
            '<th style="text-align:left;padding:8px;color:var(--gold);letter-spacing:2px;font-size:11px">MAC ADDRESS</th>' +
            '<th style="text-align:left;padding:8px;color:var(--gold);letter-spacing:2px;font-size:11px">UPTIME</th>' +
            '</tr></thead><tbody>' +
            devices.map(d =>
                '<tr style="border-bottom:1px solid #222" onmouseenter="this.style.background=\'#111133\'" onmouseleave="this.style.background=\'transparent\'">' +
                '<td style="padding:10px 8px"><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:' + (d.state===1?'#55ff55':'#cc4444') + ';box-shadow:0 0 8px ' + (d.state===1?'#55ff55':'#cc4444') + '"></span></td>' +
                '<td style="padding:10px 8px;color:' + (d.state===1?'var(--gold)':'#666') + ';font-weight:700">' + d.name + '</td>' +
                '<td style="padding:10px 8px;color:var(--ltblue)">' + d.model + '</td>' +
                '<td style="padding:10px 8px;color:var(--purple)">' + (d.type==='uap'?'\uD83D\uDCE1 ACCESS POINT':'\uD83D\uDD0C SWITCH') + '</td>' +
                '<td style="padding:10px 8px;color:#666;font-family:monospace;font-size:11px">' + d.mac + '</td>' +
                '<td style="padding:10px 8px;color:' + (d.state===1?'var(--green)':'var(--red)') + '">' + (d.state===1?formatUptime(d.uptime):'OFFLINE') + '</td></tr>'
            ).join('') +
            '</tbody></table>';
    }

    // ============ BUILD WI-FI STALKER ============
    function buildStalker(devices) {
        const aps = devices.filter(d => d.type === 'uap');
        document.getElementById('panel-stalker').innerHTML =
            '<div class="section-title">WI-FI CLIENT TRACKING</div>' +
            '<div style="background:#0a0a1a;border:1px solid var(--blue);padding:20px;margin-bottom:15px">' +
            '<div style="color:var(--blue);font-size:13px;letter-spacing:2px;margin-bottom:10px">TRACKING STATUS</div>' +
            '<div style="color:var(--gold);font-size:11px">Monitor Wi-Fi clients as they roam between access points. Enter a MAC address to track.</div>' +
            '<div style="margin-top:15px;display:flex;gap:10px">' +
            '<input type="text" placeholder="ENTER MAC ADDRESS..." style="flex:1;background:#000;border:1px solid var(--blue);color:var(--gold);padding:10px;font-family:var(--heading);font-size:14px;letter-spacing:1px">' +
            '<button style="background:var(--blue);color:#000;border:none;padding:10px 25px;font-family:var(--heading);font-weight:700;letter-spacing:2px;cursor:pointer">TRACK</button>' +
            '</div></div>' +
            '<div class="section-title">ACTIVE ACCESS POINTS</div>' +
            aps.map(d =>
                '<div class="client-row" style="border-left-color:' + (d.state===1?'var(--blue)':'var(--red)') + '">' +
                '<div style="width:30px;height:30px;border-radius:50%;background:rgba(153,153,255,.15);border:1px solid ' + (d.state===1?'var(--blue)':'var(--red)') + ';display:flex;align-items:center;justify-content:center;font-size:14px">\uD83D\uDCE1</div>' +
                '<div style="color:' + (d.state===1?'var(--gold)':'#666') + ';font-weight:700">' + d.name + '</div>' +
                '<div style="font-family:monospace;color:#666;font-size:11px">' + d.mac + '</div>' +
                '<div style="color:' + (d.state===1?'var(--green)':'var(--red)') + '">' + (d.state===1?'ACTIVE':'OFFLINE') + '</div>' +
                '<div style="color:var(--purple)">' + d.model + '</div>' +
                '<div style="color:' + (d.state===1?'var(--cyan)':'#444') + '">' + (d.state===1?formatUptime(d.uptime):'-') + '</div>' +
                '</div>'
            ).join('') +
            '<div class="section-title" style="margin-top:20px">ROAMING LOG</div>' +
            '<div id="stalker-log" style="background:#050510;border:1px solid #222;padding:15px;font-family:monospace;font-size:11px;color:#555;height:150px;overflow-y:auto">' +
            '<div style="color:var(--green)">[' + new Date().toLocaleTimeString() + '] Wi-Fi tracking system initialized</div>' +
            '<div style="color:var(--blue)">[' + new Date().toLocaleTimeString() + '] Monitoring ' + aps.filter(a=>a.state===1).length + ' active access points</div>' +
            '</div>';
    }

    // ============ BUILD THREATS ============
    function buildThreats(sys) {
        document.getElementById('panel-threats').innerHTML =
            '<div class="section-title">THREAT ANALYSIS \u2014 SHIELDS STATUS</div>' +
            '<div class="overview-grid">' +
            '<div class="stat-card" style="border-left-color:var(--red)"><div class="card-label">IDS/IPS STATUS</div><div class="card-value" style="font-size:20px;color:var(--red)">UNAVAILABLE</div><div class="card-sub">CLOUD HOSTED \u2014 NO LOCAL GATEWAY</div></div>' +
            '<div class="stat-card" style="border-left-color:var(--gold)"><div class="card-label">GATEWAY TYPE</div><div class="card-value" style="font-size:20px;color:var(--gold)">CLOUD</div><div class="card-sub">UDM/UCG/UXG REQUIRED FOR IDS/IPS</div></div>' +
            '<div class="stat-card" style="border-left-color:var(--cyan)"><div class="card-label">THREAT LEVEL</div><div class="card-value" style="font-size:20px;color:var(--cyan)">UNKNOWN</div><div class="card-sub">NO SENSOR DATA AVAILABLE</div></div>' +
            '</div>' +
            '<div class="section-title">DEFENSE GRID</div>' +
            '<div class="threat-panel"><div class="threat-title">\u26A0 INTRUSION DETECTION SYSTEM</div><div class="threat-info">IDS/IPS monitoring requires a UniFi Gateway device (UDM, UCG, UXG, or USG). Your Cloud Hosted configuration does not support local threat detection.</div></div>' +
            '<div class="threat-panel" style="border-color:var(--gold);border-left-color:var(--gold)"><div class="threat-title" style="color:var(--gold)">RECOMMENDATION</div><div class="threat-info">Deploy a UniFi Dream Machine or Cloud Gateway to enable real-time IDS/IPS threat detection, GeoIP-based threat mapping, deep packet inspection, and traffic analysis.</div></div>' +
            '<div class="section-title">ABUSEIPDB INTELLIGENCE</div>' +
            '<div style="background:#0a0a1a;border:1px solid var(--purple);padding:20px">' +
            '<div style="color:var(--purple);font-size:12px;letter-spacing:2px;margin-bottom:10px">IP REPUTATION LOOKUP</div>' +
            '<div style="display:flex;gap:10px">' +
            '<input type="text" placeholder="ENTER IP ADDRESS..." style="flex:1;background:#000;border:1px solid var(--purple);color:var(--gold);padding:10px;font-family:var(--heading);font-size:14px">' +
            '<button style="background:var(--purple);color:#000;border:none;padding:10px 25px;font-family:var(--heading);font-weight:700;letter-spacing:2px;cursor:pointer">ANALYZE</button>' +
            '</div></div>';
    }

    // ============ BUILD PULSE ============
    function buildPulse(devices, sys) {
        const online = devices.filter(d => d.state === 1).length;
        document.getElementById('panel-pulse').innerHTML =
            '<div class="section-title">NETWORK PULSE \u2014 REAL-TIME TELEMETRY</div>' +
            '<div class="pulse-grid">' +
            '<div class="pulse-meter"><div class="meter-label">DEVICES ONLINE</div><div class="meter-value" style="color:var(--green)">' + online + '/' + devices.length + '</div><div class="meter-bar"><div class="meter-fill" style="width:' + Math.round(online/devices.length*100) + '%"></div></div></div>' +
            '<div class="pulse-meter"><div class="meter-label">NETWORK LOAD</div><div class="meter-value">--</div><div class="meter-bar"><div class="meter-fill" style="width:0%"></div></div><div style="font-size:10px;color:#555;margin-top:5px">CLOUD HOSTED \u2014 NO CPU/RAM DATA</div></div>' +
            '<div class="pulse-meter"><div class="meter-label">CONNECTED CLIENTS</div><div class="meter-value" style="color:var(--blue)">' + (sys.num_clients||0) + '</div><div class="meter-bar"><div class="meter-fill" style="width:' + Math.min((sys.num_clients||0),100) + '%;background:linear-gradient(90deg,var(--blue),var(--purple))"></div></div></div>' +
            '</div>' +
            '<div class="section-title" style="margin-top:20px">SYSTEM HEARTBEAT</div>' +
            '<div style="display:grid;grid-template-columns:repeat(' + devices.length + ',1fr);gap:6px">' +
            devices.map(d =>
                '<div style="background:#0a0a1a;border:1px solid ' + (d.state===1?'#333':'#cc4444') + ';padding:12px;text-align:center">' +
                '<div style="font-size:20px;margin-bottom:5px">' + (d.type==='uap'?'\uD83D\uDCE1':'\uD83D\uDD0C') + '</div>' +
                '<div style="font-size:10px;color:' + (d.state===1?'var(--gold)':'#666') + ';font-weight:700;margin-bottom:3px">' + (d.name.length>12?d.name.substring(0,10)+'..':d.name) + '</div>' +
                '<div style="width:10px;height:10px;border-radius:50%;background:' + (d.state===1?'#55ff55':'#cc4444') + ';margin:0 auto;box-shadow:0 0 10px ' + (d.state===1?'#55ff55':'#cc4444') + '"></div></div>'
            ).join('') +
            '</div>' +
            '<div class="section-title" style="margin-top:20px">LIVE DATA STREAM</div>' +
            '<div id="pulse-log" style="background:#050510;border:1px solid #222;padding:10px;font-family:monospace;font-size:11px;height:120px;overflow-y:auto"></div>';

        // Start live log
        const entries = [
            {c:'#55ff55',m:'System health check: All primary systems nominal'},
            {c:'#88ddff',m:'AP signal strength: optimal'},
            {c:'#f1a727',m:'Switch port scan: all ports responding'},
            {c:'#9999ff',m:'Client count update: ' + (sys.num_clients||0) + ' active connections'},
            {c:'#cc4444',m:'Warning: Offline device detected'}
        ];
        setInterval(() => {
            const log = document.getElementById('pulse-log');
            if (!log) return;
            const e = entries[Math.floor(Math.random()*entries.length)];
            const div = document.createElement('div');
            div.style.color = e.c;
            div.textContent = '[' + new Date().toLocaleTimeString() + '] ' + e.m;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
            if (log.children.length > 50) log.removeChild(log.firstChild);
        }, 3000);
    }

    // ============ BUILD SETTINGS ============
    function buildSettings() {
        document.getElementById('panel-settings').innerHTML =
            '<div class="section-title">SYSTEM CONFIGURATION</div>' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">' +
            '<div style="background:#0a0a1a;border:1px solid var(--gold);padding:20px">' +
            '<div style="color:var(--gold);font-size:13px;letter-spacing:2px;margin-bottom:15px">UNIFI CONNECTION</div>' +
            '<div style="margin-bottom:10px"><label style="font-size:11px;color:var(--blue);letter-spacing:1px">CONTROLLER ADDRESS</label><input type="text" id="cfg-host" value="" style="width:100%;background:#000;border:1px solid #333;color:var(--gold);padding:8px;margin-top:4px;font-family:var(--heading)"></div>' +
            '<div style="margin-bottom:10px"><label style="font-size:11px;color:var(--blue);letter-spacing:1px">USERNAME</label><input type="text" id="cfg-user" style="width:100%;background:#000;border:1px solid #333;color:var(--gold);padding:8px;margin-top:4px;font-family:var(--heading)"></div>' +
            '<div style="margin-bottom:15px"><label style="font-size:11px;color:var(--blue);letter-spacing:1px">PASSWORD</label><input type="password" id="cfg-pass" style="width:100%;background:#000;border:1px solid #333;color:var(--gold);padding:8px;margin-top:4px;font-family:var(--heading)"></div>' +
            '<button onclick="saveConfig()" style="background:var(--gold);color:#000;border:none;padding:10px 20px;font-family:var(--heading);font-weight:700;letter-spacing:2px;cursor:pointer">SAVE CONNECTION</button>' +
            '</div>' +
            '<div style="background:#0a0a1a;border:1px solid var(--purple);padding:20px">' +
            '<div style="color:var(--purple);font-size:13px;letter-spacing:2px;margin-bottom:15px">DISPLAY SETTINGS</div>' +
            '<div style="margin-bottom:15px;display:flex;gap:10px;align-items:center"><label style="font-size:11px;color:var(--blue);letter-spacing:1px">RED ALERT MODE</label><button onclick="document.body.classList.toggle(\'red-alert\')" style="background:var(--red);color:#000;border:none;padding:6px 15px;font-family:var(--heading);font-weight:700;letter-spacing:1px;cursor:pointer;font-size:11px">TOGGLE</button></div>' +
            '<div style="margin-bottom:15px;display:flex;gap:10px;align-items:center"><label style="font-size:11px;color:var(--blue);letter-spacing:1px">SCAN LINES</label><button onclick="document.querySelector(\'.scanline\').style.display=document.querySelector(\'.scanline\').style.display===\'none\'?\'block\':\'none\'" style="background:var(--cyan);color:#000;border:none;padding:6px 15px;font-family:var(--heading);font-weight:700;letter-spacing:1px;cursor:pointer;font-size:11px">TOGGLE</button></div>' +
            '</div></div>' +
            '<div class="section-title" style="margin-top:20px">SYSTEM INFORMATION</div>' +
            '<div style="background:#0a0a1a;border:1px solid #333;padding:15px;font-family:monospace;font-size:12px">' +
            '<div style="color:var(--gold)">MEEHAN NETWORK COMMAND v2.0</div>' +
            '<div style="color:#666;margin-top:5px">Based on UI Toolkit for UniFi</div>' +
            '<div style="color:#666">Modified by M33HAN \u2022 MEEHAN Interface</div>' +
            '<div style="color:var(--green);margin-top:10px">Status: Connected</div></div>';
    }

    async function saveConfig() {
        const host = document.getElementById('cfg-host').value;
        const user = document.getElementById('cfg-user').value;
        const pass = document.getElementById('cfg-pass').value;
        try {
            await fetch('/api/configure', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({host, username: user, password: pass, port: 443, site: 'default', verify_ssl: false})
            });
            alert('Configuration saved. Reloading...');
            location.reload();
        } catch(e) { alert('Error saving: ' + e.message); }
    }


    // ============ BUILD CREDITS & ATTRIBUTION ============
    function buildCredits() {
        var panel = document.getElementById('panel-credits');
        if (!panel) return;
        var health = window._pulseHealth || {};
        var healthSection = '';
        if (health.wlan_status || health.lan_status) {
            var items = [{label:'WLAN',status:health.wlan_status,reason:health.wlan_reason},{label:'LAN',status:health.lan_status,reason:health.lan_reason},{label:'WAN',status:health.wan_status,reason:health.wan_reason}];
            healthSection = '<div style="margin-top:30px;padding:20px;background:rgba(0,180,255,0.05);border:1px solid rgba(0,180,255,0.15);border-radius:12px">' +
                '<h3 style="color:#00b4ff;margin:0 0 15px 0;font-size:14px;letter-spacing:2px">NETWORK HEALTH STATUS</h3>' +
                '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px">' +
                items.map(function(item) {
                    var color = item.status === 'ok' ? '#0f8' : item.status === 'warning' ? '#fa0' : '#f55';
                    var bc = item.status === 'ok' ? 'rgba(0,255,136,0.3)' : item.status === 'warning' ? 'rgba(255,170,0,0.3)' : 'rgba(255,80,80,0.3)';
                    return '<div style="text-align:center;padding:15px;background:rgba(0,0,0,0.3);border-radius:8px;border:1px solid ' + bc + '"><div style="font-size:11px;color:#888;letter-spacing:1px">' + item.label + '</div><div style="font-size:18px;font-weight:bold;color:' + color + ';margin:5px 0">' + (item.status || 'N/A').toUpperCase() + '</div><div style="font-size:10px;color:#666">' + (item.reason || '') + '</div></div>';
                }).join('') + '</div></div>';
        }
        panel.innerHTML = '<div style="max-width:800px;margin:0 auto;padding:40px 20px;text-align:center">' +
            '<div style="margin-bottom:40px"><div style="font-size:48px;margin-bottom:10px">\u2727</div>' +
            '<h1 style="color:#00b4ff;font-size:28px;font-weight:300;letter-spacing:6px;margin:0">CREDITS & ATTRIBUTION</h1>' +
            '<div style="width:200px;height:1px;background:linear-gradient(90deg,transparent,#00b4ff,transparent);margin:15px auto"></div></div>' +
            '<div style="background:rgba(0,180,255,0.08);border:1px solid rgba(0,180,255,0.2);border-radius:16px;padding:40px;margin-bottom:30px;backdrop-filter:blur(10px)">' +
            '<div style="font-size:13px;color:#00b4ff;letter-spacing:3px;margin-bottom:20px">ORIGINAL PROJECT</div>' +
            '<h2 style="color:#fff;font-size:24px;font-weight:400;margin:0 0 10px 0">UI Toolkit for UniFi</h2>' +
            '<p style="color:#aaa;font-size:14px;line-height:1.6;margin:0 0 25px 0">This project is a fork of the original <strong style="color:#00b4ff">UI Toolkit for UniFi</strong> created by <strong style="color:#0f8">Crosstalk Solutions</strong>. We extend our deepest gratitude for building this incredible foundation and releasing it under the MIT license, enabling the community to innovate and build upon their work.</p>' +
            '<div style="font-size:12px;color:#888;padding:15px;background:rgba(0,0,0,0.3);border-radius:8px;font-family:monospace;margin-bottom:25px">MIT License \u00A9 Crosstalk Solutions<br>Original Repository: github.com/Crosstalk-Solutions/unifi-toolkit</div>' +
            '<div style="font-size:13px;color:#00b4ff;letter-spacing:3px;margin-bottom:20px">CONNECT WITH CROSSTALK SOLUTIONS</div>' +
            '<div style="display:flex;flex-wrap:wrap;justify-content:center;gap:12px">' +
            '<a href="https://www.crosstalksolutions.com" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:8px;padding:12px 20px;background:rgba(0,180,255,0.1);border:1px solid rgba(0,180,255,0.3);border-radius:8px;color:#00b4ff;text-decoration:none;font-size:13px">\u{1F310} Website</a>' +
            '<a href="https://youtube.com/crosstalksolutions" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:8px;padding:12px 20px;background:rgba(255,0,0,0.08);border:1px solid rgba(255,0,0,0.3);border-radius:8px;color:#ff4444;text-decoration:none;font-size:13px">\u25B6 YouTube</a>' +
            '<a href="https://twitter.com/crosstalksol" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:8px;padding:12px 20px;background:rgba(29,155,240,0.08);border:1px solid rgba(29,155,240,0.3);border-radius:8px;color:#1d9bf0;text-decoration:none;font-size:13px">\u{1D54F} Twitter/X</a>' +
            '<a href="https://www.linkedin.com/company/crosstalk-solutions/" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:8px;padding:12px 20px;background:rgba(0,119,181,0.08);border:1px solid rgba(0,119,181,0.3);border-radius:8px;color:#0077b5;text-decoration:none;font-size:13px">\u{1F4BC} LinkedIn</a>' +
            '<a href="https://github.com/Crosstalk-Solutions/unifi-toolkit" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:8px;padding:12px 20px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;text-decoration:none;font-size:13px">\u2B50 GitHub (133+ Stars)</a></div></div>' +
            '<div style="background:rgba(0,255,136,0.05);border:1px solid rgba(0,255,136,0.15);border-radius:16px;padding:30px;margin-bottom:30px">' +
            '<div style="font-size:13px;color:#0f8;letter-spacing:3px;margin-bottom:15px">MEEHAN DESIGN FORK</div>' +
            '<p style="color:#aaa;font-size:14px;line-height:1.6;margin:0 0 15px 0"><strong style="color:#0f8">MEEHAN Design v3.0</strong> is a customized fork featuring a Star Trek-inspired LCARS interface, real-time network monitoring, threat analysis, Wi-Fi tracking, and an advanced modern UI overlay.</p>' +
            '<div style="display:flex;justify-content:center;gap:20px;flex-wrap:wrap">' +
            ['LCARS Interface','Threat Analysis','Wi-Fi Stalker','Network Pulse','Modern UI','Deck Plans'].map(function(f) { return '<div style="padding:10px 15px;background:rgba(0,0,0,0.3);border-radius:6px;font-size:12px;color:#888"><span style="color:#0f8">\u2713</span> ' + f + '</div>'; }).join('') +
            '</div></div>' + healthSection +
            '<div style="margin-top:30px;padding:20px;border-top:1px solid rgba(255,255,255,0.05)"><p style="color:#555;font-size:12px;line-height:1.8;margin:0">FIREWIRE NETWORKS LTD \u2022 UNITED FEDERATION OF NETWORKS \u2022 M33HAN COMMAND<br>Built with \u2764 for the network engineering community<br><span style="color:#333">Powered by UniFi \u2022 Python \u2022 FastAPI</span></p></div></div>';
    }


    // ============ ENHANCE WITH PULSE DATA ============
    function enhancePulseData() {
        var aps = window._pulseAPs;
        var clients = window._pulseClients;
        var health = window._pulseHealth;
        if (!aps && !clients && !health) return;
        var overviewPanel = document.getElementById('panel-overview');
        if (overviewPanel && health) {
            var healthBar = document.createElement('div');
            healthBar.style.cssText = 'margin-bottom:20px;padding:15px;background:rgba(0,0,0,0.3);border-radius:10px;display:flex;justify-content:space-around;flex-wrap:wrap;gap:10px';
            var items = [{label:'WLAN',status:health.wlan_status,reason:health.wlan_reason},{label:'LAN',status:health.lan_status,reason:health.lan_reason},{label:'WAN',status:health.wan_status,reason:health.wan_reason},{label:'WIRELESS',value:health.wireless_clients||'-'},{label:'WIRED',value:health.wired_clients||'-'},{label:'TOTAL',value:health.total_clients||'-'}];
            healthBar.innerHTML = items.map(function(item) { if (item.status !== undefined) { var color = item.status === 'ok' ? '#0f8' : item.status === 'warning' ? '#fa0' : '#f55'; return '<div style="text-align:center;min-width:80px"><div style="font-size:10px;color:#666;letter-spacing:1px">' + item.label + '</div><div style="font-size:14px;font-weight:bold;color:' + color + ';margin:3px 0">' + (item.status||'').toUpperCase() + '</div><div style="font-size:9px;color:#555">' + (item.reason||'') + '</div></div>'; } else { return '<div style="text-align:center;min-width:60px"><div style="font-size:10px;color:#666;letter-spacing:1px">' + item.label + '</div><div style="font-size:18px;font-weight:bold;color:#00b4ff;margin:3px 0">' + item.value + '</div></div>'; } }).join('');
            overviewPanel.insertBefore(healthBar, overviewPanel.firstChild);
        }
        if (overviewPanel && aps && aps.access_points) {
            var apSection = document.createElement('div');
            apSection.style.cssText = 'margin-top:20px;padding:20px;background:rgba(0,180,255,0.05);border:1px solid rgba(0,180,255,0.15);border-radius:12px';
            apSection.innerHTML = '<h3 style="color:#00b4ff;margin:0 0 15px 0;font-size:13px;letter-spacing:2px">ACCESS POINT TELEMETRY</h3><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px">' + aps.access_points.map(function(ap) { var sat = ap.satisfaction || 0; var sc = sat >= 90 ? '#0f8' : sat >= 70 ? '#fa0' : '#f55'; return '<div style="padding:12px;background:rgba(0,0,0,0.3);border-radius:8px;border-left:3px solid ' + sc + '"><div style="font-size:12px;color:#fff;font-weight:500">' + (ap.name||ap.mac||'Unknown AP') + '</div><div style="display:flex;justify-content:space-between;margin-top:8px"><span style="font-size:11px;color:#888">Satisfaction</span><span style="font-size:13px;font-weight:bold;color:' + sc + '">' + sat + '%</span></div><div style="display:flex;justify-content:space-between;margin-top:4px"><span style="font-size:11px;color:#888">Clients</span><span style="font-size:13px;color:#00b4ff">' + (ap.num_clients||0) + '</span></div></div>'; }).join('') + '</div>';
            overviewPanel.appendChild(apSection);
        }
        if (overviewPanel && clients && clients.top_clients) {
            var cs = document.createElement('div');
            cs.style.cssText = 'margin-top:15px;padding:20px;background:rgba(0,255,136,0.03);border:1px solid rgba(0,255,136,0.12);border-radius:12px';
            cs.innerHTML = '<h3 style="color:#0f8;margin:0 0 15px 0;font-size:13px;letter-spacing:2px">TOP CONNECTED CLIENTS</h3><div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px"><tr style="border-bottom:1px solid rgba(255,255,255,0.05)"><th style="text-align:left;padding:8px;color:#888;font-weight:500">Name</th><th style="text-align:left;padding:8px;color:#888;font-weight:500">IP</th><th style="text-align:left;padding:8px;color:#888;font-weight:500">SSID</th><th style="text-align:right;padding:8px;color:#888;font-weight:500">Signal</th><th style="text-align:right;padding:8px;color:#888;font-weight:500">Type</th></tr>' + clients.top_clients.slice(0,10).map(function(cl) { var rssi = cl.rssi||0; var rc = rssi >= -50 ? '#0f8' : rssi >= -70 ? '#fa0' : '#f55'; return '<tr style="border-bottom:1px solid rgba(255,255,255,0.03)"><td style="padding:8px;color:#ddd">' + (cl.name||cl.hostname||'Unknown') + '</td><td style="padding:8px;color:#888;font-family:monospace;font-size:11px">' + (cl.ip||'N/A') + '</td><td style="padding:8px;color:#00b4ff">' + (cl.ssid||(cl.is_wired?'Wired':'N/A')) + '</td><td style="padding:8px;text-align:right;color:' + rc + '">' + (cl.is_wired?'-':rssi+' dBm') + '</td><td style="padding:8px;text-align:right"><span style="padding:2px 8px;border-radius:4px;font-size:10px;background:' + (cl.is_wired?'rgba(0,180,255,0.15);color:#00b4ff':'rgba(0,255,136,0.15);color:#0f8') + '">' + (cl.is_wired?'WIRED':'WIFI') + '</span></td></tr>'; }).join('') + '</table></div>';
            overviewPanel.appendChild(cs);
        }
    }

    // ============ BUILD DECK PLAN (Starship Schematic) ============
    function buildDeckPlan() {
        const panel = document.getElementById('panel-deckplan');
        panel.dataset.built = '1';
        const devices = networkData.system.devices || [];
        const aps = devices.filter(d => d.type === 'uap');
        const sws = devices.filter(d => d.type === 'usw');
        const ncc = 'NCC-' + String(Math.floor(Math.random()*90000+10000));

        let svg = '<div class="schematic-container"><svg viewBox="0 0 1200 650" xmlns="http://www.w3.org/2000/svg">';
        svg += '<defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="rgba(50,50,100,.3)" stroke-width=".5"/></pattern>';
        svg += '<filter id="glow"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>';

        // Background
        svg += '<rect width="1200" height="650" fill="url(#grid)"/>';

        // MEEHAN frame
        svg += '<rect x="10" y="8" width="100" height="20" rx="10" fill="#f1a727"/>';
        svg += '<text x="60" y="22" text-anchor="middle" font-family="Antonio,sans-serif" font-size="11" fill="#000" font-weight="700">M33HAN CLASS</text>';
        svg += '<rect x="120" y="8" width="400" height="20" rx="10" fill="#9999ff"/>';
        svg += '<text x="320" y="22" text-anchor="middle" font-family="Antonio,sans-serif" font-size="11" fill="#000" font-weight="700" letter-spacing="3">N.S.S. NETWORK \u2014 ' + ncc + '</text>';
        svg += '<rect x="530" y="8" width="80" height="20" rx="10" fill="#cc99cc"/>';
        svg += '<text x="570" y="22" text-anchor="middle" font-family="Antonio,sans-serif" font-size="10" fill="#000" font-weight="700">DECK 1</text>';

        // Frame bars
        svg += '<rect x="10" y="35" width="8" height="580" rx="4" fill="#f1a727"/>';
        svg += '<rect x="10" y="610" width="200" height="8" rx="4" fill="#f1a727"/>';
        svg += '<rect x="1182" y="35" width="8" height="580" rx="4" fill="#9999ff"/>';
        svg += '<rect x="990" y="610" width="200" height="8" rx="4" fill="#9999ff"/>';

        // Ship hull
        svg += '<ellipse cx="600" cy="280" rx="380" ry="160" fill="rgba(20,20,50,.5)" stroke="#334" stroke-width="2"/>';
        svg += '<ellipse cx="600" cy="280" rx="320" ry="130" fill="none" stroke="rgba(68,85,255,.3)" stroke-width="1" stroke-dasharray="8,4"/>';

        // Nacelle struts
        svg += '<path d="M 430 380 L 370 520 L 400 540 L 450 540 L 480 400" fill="rgba(20,20,50,.5)" stroke="#334" stroke-width="2"/>';
        svg += '<path d="M 770 380 L 830 520 L 800 540 L 750 540 L 720 400" fill="rgba(20,20,50,.5)" stroke="#334" stroke-width="2"/>';

        // Nacelles
        svg += '<rect x="330" y="520" rx="15" width="160" height="40" fill="rgba(20,20,80,.6)" stroke="#4455ff" stroke-width="2"/>';
        svg += '<line x1="350" y1="540" x2="480" y2="540" stroke="#4455ff" stroke-width="2" filter="url(#glow)"><animate attributeName="stroke-opacity" values=".3;1;.3" dur="2s" repeatCount="indefinite"/></line>';
        svg += '<rect x="710" y="520" rx="15" width="160" height="40" fill="rgba(20,20,80,.6)" stroke="#4455ff" stroke-width="2"/>';
        svg += '<line x1="720" y1="540" x2="850" y2="540" stroke="#4455ff" stroke-width="2" filter="url(#glow)"><animate attributeName="stroke-opacity" values=".3;1;.3" dur="2s" repeatCount="indefinite" begin=".5s"/></line>';
        svg += '<text x="410" y="590" text-anchor="middle" font-family="Antonio,sans-serif" font-size="10" fill="#4455ff" letter-spacing="2">PORT NACELLE</text>';
        svg += '<text x="790" y="590" text-anchor="middle" font-family="Antonio,sans-serif" font-size="10" fill="#4455ff" letter-spacing="2">STARBOARD NACELLE</text>';

        // Bridge
        svg += '<circle cx="600" cy="170" r="45" fill="rgba(241,167,39,.1)" stroke="#f1a727" stroke-width="2"/>';
        svg += '<circle cx="600" cy="170" r="30" fill="rgba(241,167,39,.05)" stroke="rgba(241,167,39,.5)" stroke-width="1"/>';
        svg += '<text x="600" y="145" text-anchor="middle" font-family="Antonio,sans-serif" font-size="9" fill="#f1a727" opacity=".7">COMMAND CENTER</text>';
        svg += '<text x="600" y="175" text-anchor="middle" font-family="Antonio,sans-serif" font-size="12" fill="#f1a727" font-weight="700" letter-spacing="2">BRIDGE</text>';

        // Section lines
        svg += '<line x1="600" y1="120" x2="600" y2="440" stroke="rgba(100,100,150,.2)" stroke-width="1" stroke-dasharray="4,4"/>';
        svg += '<line x1="220" y1="280" x2="980" y2="280" stroke="rgba(100,100,150,.2)" stroke-width="1" stroke-dasharray="4,4"/>';

        // Switches
        var swPositions = [{x:600,y:280,name:'MAIN CORE'},{x:380,y:280,name:'SEC CORE'},{x:820,y:280,name:''}];
        sws.forEach((s, i) => {
            var p = swPositions[i] || {x:600+i*100,y:280,name:''};
            var col = s.state===1 ? '#55ff55' : '#cc4444';
            var dash = s.state===1 ? '' : ' stroke-dasharray="4,2"';
            svg += '<g transform="translate(' + p.x + ',' + p.y + ')">';
            svg += '<rect x="-60" y="-25" width="120" height="50" rx="5" fill="rgba(' + (s.state===1?'85,255,85':'204,68,68') + ',.08)" stroke="' + col + '" stroke-width="' + (i===0?'1.5':'1') + '"' + dash + '/>';
            if (s.state===1) svg += '<circle cx="0" cy="0" r="8" fill="' + col + '" opacity=".8"><animate attributeName="r" values="8;12;8" dur="3s" repeatCount="indefinite"/><animate attributeName="opacity" values=".8;.3;.8" dur="3s" repeatCount="indefinite"/></circle>';
            svg += '<circle cx="0" cy="0" r="5" fill="' + col + '"' + (s.state!==1?' opacity=".5"':'') + '/>';
            svg += '<text x="0" y="-12" text-anchor="middle" font-family="Antonio,sans-serif" font-size="8" fill="' + col + '" letter-spacing="1">' + s.name.toUpperCase() + '</text>';
            svg += '<text x="0" y="20" text-anchor="middle" font-family="Antonio,sans-serif" font-size="10" fill="' + (s.state===1?'#f1a727':'#cc4444') + '" font-weight="700">' + (p.name || (s.state===1?'ONLINE':'OFFLINE')) + '</text>';
            svg += '</g>';
        });

        // Switch connections
        svg += '<line x1="430" y1="280" x2="540" y2="280" stroke="#55ff55" stroke-width="1.5" opacity=".5" filter="url(#glow)"><animate attributeName="stroke-opacity" values=".3;.8;.3" dur="1.5s" repeatCount="indefinite"/></line>';
        svg += '<line x1="660" y1="280" x2="770" y2="280" stroke="#cc4444" stroke-width="1" opacity=".3" stroke-dasharray="4,4"/>';

        // AP positions around ship
        var apPos = [{x:350,y:190},{x:850,y:190},{x:600,y:220},{x:350,y:370},{x:850,y:370}];
        aps.forEach((a, i) => {
            var p = apPos[i] || {x:400+i*100,y:200};
            var col = a.state===1 ? '#88ddff' : '#cc4444';
            var dash = a.state!==1 ? ' stroke-dasharray="4,2"' : '';
            svg += '<g transform="translate(' + p.x + ',' + p.y + ')">';
            svg += '<circle cx="0" cy="0" r="22" fill="rgba(' + (a.state===1?'136,221,255':'204,68,68') + ',.08)" stroke="' + col + '" stroke-width="' + (a.state===1?'1.5':'1') + '"' + dash + '/>';
            if (a.state===1) {
                svg += '<circle cx="0" cy="0" r="30" fill="none" stroke="' + col + '" stroke-width=".5" opacity="0">';
                svg += '<animate attributeName="r" values="22;35;22" dur="3s" repeatCount="indefinite" begin="' + (i*0.5) + 's"/>';
                svg += '<animate attributeName="opacity" values=".5;0;.5" dur="3s" repeatCount="indefinite" begin="' + (i*0.5) + 's"/></circle>';
            }
            svg += '<text x="0" y="12" text-anchor="middle" font-family="Antonio,sans-serif" font-size="8" fill="' + col + '">' + (a.name.length>15?a.name.substring(0,12)+'..':a.name).toUpperCase() + '</text>';
            svg += '<text x="0" y="38" text-anchor="middle" font-family="Antonio,sans-serif" font-size="7" fill="' + (a.state===1?'#55ff55':'#cc4444') + '">\u25CF ' + (a.state===1?'ONLINE':'OFFLINE') + '</text>';
            svg += '</g>';
            // Connection line to main switch
            svg += '<line x1="' + p.x + '" y1="' + (p.y+(p.y<280?20:-20)) + '" x2="600" y2="' + (p.y<280?'255':'305') + '" stroke="rgba(' + (a.state===1?'136,221,255,.3':'204,68,68,.15') + ')" stroke-width="1"' + (a.state!==1?' stroke-dasharray="4,4"':'') + '/>';
        });

        // Annotations
        svg += '<text x="30" y="55" font-family="Antonio,sans-serif" font-size="9" fill="#f1a727" opacity=".6" letter-spacing="2">DEVICES: ' + devices.length + '</text>';
        svg += '<text x="30" y="70" font-family="Antonio,sans-serif" font-size="9" fill="#f1a727" opacity=".6" letter-spacing="2">CLIENTS: ' + (networkData.system.num_clients||0) + '</text>';
        svg += '<text x="30" y="85" font-family="Antonio,sans-serif" font-size="9" fill="#f1a727" opacity=".6" letter-spacing="2">APs: ' + aps.length + '</text>';
        svg += '<text x="30" y="100" font-family="Antonio,sans-serif" font-size="9" fill="#f1a727" opacity=".6" letter-spacing="2">SWITCHES: ' + sws.length + '</text>';
        svg += '<text x="1170" y="55" text-anchor="end" font-family="Antonio,sans-serif" font-size="9" fill="#9999ff" opacity=".6" letter-spacing="2">MEEHAN SCHEMATIC</text>';
        svg += '<text x="1170" y="70" text-anchor="end" font-family="Antonio,sans-serif" font-size="9" fill="#9999ff" opacity=".6" letter-spacing="2">VIEW: TOP-DOWN</text>';

        // Data blocks
        svg += '<rect x="30" y="440" width="160" height="80" fill="rgba(153,153,255,.08)" stroke="#9999ff" stroke-width="1"/>';
        svg += '<text x="40" y="458" font-family="Antonio,sans-serif" font-size="9" fill="#9999ff" letter-spacing="2">POWER SYSTEMS</text>';
        svg += '<text x="40" y="478" font-family="monospace" font-size="11" fill="#f1a727">POE BUDGET: ACTIVE</text>';
        svg += '<text x="40" y="495" font-family="monospace" font-size="11" fill="#55ff55">STATUS: NOMINAL</text>';

        svg += '<rect x="1010" y="440" width="160" height="80" fill="rgba(204,153,204,.08)" stroke="#cc99cc" stroke-width="1"/>';
        svg += '<text x="1020" y="458" font-family="Antonio,sans-serif" font-size="9" fill="#cc99cc" letter-spacing="2">COMM SYSTEMS</text>';
        svg += '<text x="1020" y="478" font-family="monospace" font-size="11" fill="#f1a727">WIFI: ' + aps.length + ' ARRAYS</text>';
        svg += '<text x="1020" y="495" font-family="monospace" font-size="11" fill="#55ff55">ACTIVE: ' + aps.filter(a=>a.state===1).length + '</text>';
        svg += '<text x="1020" y="512" font-family="monospace" font-size="11" fill="#cc4444">DORMANT: ' + aps.filter(a=>a.state!==1).length + '</text>';

        // Scan line
        svg += '<line x1="220" y1="120" x2="220" y2="440" stroke="#f1a727" stroke-width=".5" opacity="0">';
        svg += '<animate attributeName="x1" values="220;980;220" dur="6s" repeatCount="indefinite"/>';
        svg += '<animate attributeName="x2" values="220;980;220" dur="6s" repeatCount="indefinite"/>';
        svg += '<animate attributeName="opacity" values="0;.4;0" dur="6s" repeatCount="indefinite"/></line>';

        svg += '</svg></div>';
        panel.innerHTML = svg;
    }

    // ============ BUILD TOPOLOGY (Space family tree) ============
    function buildTopology() {
        const panel = document.getElementById('panel-topology');
        panel.dataset.built = '1';
        const devices = networkData.system.devices || [];
        const aps = devices.filter(d => d.type === 'uap');
        const sws = devices.filter(d => d.type === 'usw');

        // Generate stars
        var stars = '';
        for (var i = 0; i < 60; i++) {
            var sx = Math.random()*1200, sy = Math.random()*650, sr = Math.random()*1.2+.2, so = Math.random()*.5+.3;
            stars += '<circle cx="' + sx + '" cy="' + sy + '" r="' + sr + '" fill="white" opacity="' + so + '"/>';
        }

        var svg = '<div class="topology-container"><svg viewBox="0 0 1200 650" xmlns="http://www.w3.org/2000/svg">';
        svg += '<defs><filter id="tglow"><feGaussianBlur stdDeviation="4" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>';
        svg += '<radialGradient id="starBg"><stop offset="0%" stop-color="#0a0a2a"/><stop offset="100%" stop-color="#000005"/></radialGradient></defs>';

        // Space background
        svg += '<rect width="1200" height="650" fill="url(#starBg)"/>';
        svg += '<g>' + stars + '</g>';
        svg += '<ellipse cx="900" cy="100" rx="200" ry="80" fill="rgba(68,85,255,.03)"/>';
        svg += '<ellipse cx="300" cy="500" rx="150" ry="60" fill="rgba(204,153,204,.03)"/>';

        // MEEHAN corner brackets
        svg += '<rect x="5" y="5" width="80" height="3" rx="1.5" fill="#f1a727"/><rect x="5" y="5" width="3" height="40" rx="1.5" fill="#f1a727"/>';
        svg += '<rect x="1115" y="5" width="80" height="3" rx="1.5" fill="#9999ff"/><rect x="1192" y="5" width="3" height="40" rx="1.5" fill="#9999ff"/>';
        svg += '<rect x="5" y="642" width="80" height="3" rx="1.5" fill="#cc99cc"/><rect x="5" y="605" width="3" height="40" rx="1.5" fill="#cc99cc"/>';
        svg += '<rect x="1115" y="642" width="80" height="3" rx="1.5" fill="#f1a727"/><rect x="1192" y="605" width="3" height="40" rx="1.5" fill="#f1a727"/>';

        // Title
        svg += '<text x="600" y="30" text-anchor="middle" font-family="Antonio,sans-serif" font-size="14" fill="#f1a727" letter-spacing="6" font-weight="700">NETWORK TOPOLOGY \u2014 LIVE SENSOR DATA</text>';

        // Cloud
        svg += '<g transform="translate(600,80)"><circle cx="0" cy="0" r="35" fill="rgba(136,221,255,.05)" stroke="#88ddff" stroke-width="2"/>';
        svg += '<circle cx="0" cy="0" r="45" fill="none" stroke="#88ddff" stroke-width=".5" opacity=".3"><animate attributeName="r" values="40;55;40" dur="4s" repeatCount="indefinite"/><animate attributeName="opacity" values=".3;0;.3" dur="4s" repeatCount="indefinite"/></circle>';
        svg += '<text x="0" y="5" text-anchor="middle" font-family="Antonio,sans-serif" font-size="12" fill="#88ddff" font-weight="700">CLOUD</text>';
        svg += '<text x="0" y="55" text-anchor="middle" font-family="Antonio,sans-serif" font-size="8" fill="#88ddff" opacity=".6">CONTROLLER</text></g>';

        // Cloud to main switch line
        svg += '<line x1="600" y1="120" x2="600" y2="200" stroke="#88ddff" stroke-width="2" filter="url(#tglow)"><animate attributeName="stroke-opacity" values=".3;1;.3" dur="2s" repeatCount="indefinite"/></line>';
        svg += '<circle r="2" fill="#88ddff"><animateMotion dur="1.5s" repeatCount="indefinite" path="M600,120 L600,200"/></circle>';

        // Main switch (first online switch)
        var mainSw = sws.find(s => s.state===1) || sws[0];
        svg += '<g transform="translate(600,240)"><rect x="-80" y="-30" width="160" height="60" rx="8" fill="rgba(85,255,85,.08)" stroke="#55ff55" stroke-width="2"/>';
        svg += '<ellipse cx="0" cy="0" rx="95" ry="20" fill="none" stroke="rgba(85,255,85,.15)" stroke-width="1"><animateTransform attributeName="transform" type="rotate" values="0;360" dur="20s" repeatCount="indefinite"/></ellipse>';
        svg += '<circle cx="0" cy="0" r="6" fill="#55ff55"/>';
        svg += '<text x="0" y="-15" text-anchor="middle" font-family="Antonio,sans-serif" font-size="11" fill="#f1a727" font-weight="700">' + (mainSw?mainSw.name.toUpperCase():'PRIMARY SWITCH') + '</text>';
        svg += '<text x="0" y="22" text-anchor="middle" font-family="Antonio,sans-serif" font-size="9" fill="#55ff55" letter-spacing="2">\u25CF PRIMARY SWITCH</text>';
        svg += '<text x="0" y="50" text-anchor="middle" font-family="monospace" font-size="8" fill="#666">' + (mainSw?mainSw.mac:'') + '</text></g>';

        // Secondary switches
        var otherSw = sws.filter(s => s !== mainSw);
        var swX = [300, 900];
        otherSw.forEach((s, i) => {
            var x = swX[i] || 600 + (i+1) * 150;
            var col = s.state===1 ? '#55ff55' : '#cc4444';
            // Connection line
            svg += '<path d="M ' + (i===0?'520':'680') + ' 250 Q ' + (i===0?'400':'800') + ' 300 ' + x + ' 350" stroke="' + col + '" stroke-width="' + (s.state===1?'1.5':'1') + '" fill="none"' + (s.state!==1?' stroke-dasharray="5,5" opacity=".3"':' filter="url(#tglow)" opacity=".6"') + '/>';
            if (s.state===1) svg += '<circle r="2" fill="' + col + '"><animateMotion dur="2s" repeatCount="indefinite" path="M' + (i===0?'520':'680') + ',250 Q' + (i===0?'400':'800') + ',300 ' + x + ',350"/></circle>';

            svg += '<g transform="translate(' + x + ',380)"><rect x="-70" y="-25" width="140" height="50" rx="6" fill="rgba(' + (s.state===1?'85,255,85':'204,68,68') + ',.06)" stroke="' + col + '" stroke-width="' + (s.state===1?'1.5':'1') + '"' + (s.state!==1?' stroke-dasharray="5,3"':'') + '/>';
            svg += '<circle cx="0" cy="0" r="5" fill="' + col + '"' + (s.state!==1?' opacity=".5"><animate attributeName="opacity" values=".5;.1;.5" dur="2s" repeatCount="indefinite"/':'') + '/>';
            svg += '<text x="0" y="-10" text-anchor="middle" font-family="Antonio,sans-serif" font-size="10" fill="' + (s.state===1?'#f1a727':col) + '" font-weight="700">' + s.name.toUpperCase() + '</text>';
            svg += '<text x="0" y="18" text-anchor="middle" font-family="Antonio,sans-serif" font-size="8" fill="' + col + '" letter-spacing="1">' + (s.state===1?'\u25CF SECONDARY':'\u26A0 OFFLINE') + '</text>';
            svg += '<text x="0" y="40" text-anchor="middle" font-family="monospace" font-size="8" fill="#666">' + s.mac + '</text></g>';
        });

        // APs spread across bottom
        var apX = [];
        var spacing = 1000 / (aps.length + 1);
        for (var i = 0; i < aps.length; i++) apX.push(100 + spacing * (i + 1));

        aps.forEach((a, i) => {
            var x = apX[i];
            var col = a.state===1 ? '#88ddff' : '#cc4444';
            // Connection to main switch
            svg += '<path d="M 600 270 Q ' + (600+(x-600)*.5) + ' 370 ' + x + ' 460" stroke="rgba(' + (a.state===1?'136,221,255,.4':'204,68,68,.2') + ')" stroke-width="1" fill="none"' + (a.state!==1?' stroke-dasharray="4,4"':'') + '/>';

            svg += '<g transform="translate(' + x + ',490)"><circle cx="0" cy="0" r="' + (a.state===1?'28':'24') + '" fill="rgba(' + (a.state===1?'136,221,255':'204,68,68') + ',.06)" stroke="' + col + '" stroke-width="' + (a.state===1?'1.5':'1') + '"' + (a.state!==1?' stroke-dasharray="4,2"':'') + '/>';
            if (a.state===1) {
                svg += '<circle cx="0" cy="0" r="35" fill="none" stroke="' + col + '" stroke-width=".5" opacity="0">';
                svg += '<animate attributeName="r" values="30;45;30" dur="3s" repeatCount="indefinite" begin="' + (i*.5) + 's"/>';
                svg += '<animate attributeName="opacity" values=".4;0;.4" dur="3s" repeatCount="indefinite" begin="' + (i*.5) + 's"/></circle>';
            }
            svg += '<text x="0" y="4" text-anchor="middle" font-family="Antonio,sans-serif" font-size="10" fill="' + col + '" font-weight="700">' + (a.name.length>12?a.name.substring(0,10)+'..':a.name).toUpperCase() + '</text>';
            svg += '<text x="0" y="50" text-anchor="middle" font-family="Antonio,sans-serif" font-size="8" fill="' + (a.state===1?'#55ff55':col) + '">\u25CF ' + (a.state===1?a.model:'OFFLINE') + '</text></g>';

            // Client dots for online APs
            if (a.state === 1) {
                var nc = Math.floor(Math.random()*8+4);
                for (var j = 0; j < nc; j++) {
                    var angle = (j/nc) * Math.PI * 2;
                    var cx = x + Math.cos(angle) * 55;
                    var cy = 550 + Math.sin(angle) * 20;
                    svg += '<circle cx="' + cx + '" cy="' + cy + '" r="3" fill="#9999ff" opacity=".4"><animate attributeName="opacity" values=".2;.6;.2" dur="' + (Math.random()*2+1).toFixed(1) + 's" repeatCount="indefinite"/></circle>';
                }
                svg += '<text x="' + x + '" y="590" text-anchor="middle" font-family="Antonio,sans-serif" font-size="8" fill="#9999ff" opacity=".5">~' + nc + ' CLIENTS</text>';
            }
        });

        // Legend
        svg += '<g transform="translate(30,620)"><circle cx="0" cy="0" r="4" fill="#55ff55"/><text x="10" y="4" font-family="Antonio,sans-serif" font-size="8" fill="#55ff55">SWITCH</text>';
        svg += '<circle cx="80" cy="0" r="4" fill="#88ddff"/><text x="90" y="4" font-family="Antonio,sans-serif" font-size="8" fill="#88ddff">AP</text>';
        svg += '<circle cx="130" cy="0" r="4" fill="#9999ff"/><text x="140" y="4" font-family="Antonio,sans-serif" font-size="8" fill="#9999ff">CLIENT</text>';
        svg += '<circle cx="200" cy="0" r="4" fill="#cc4444"/><text x="210" y="4" font-family="Antonio,sans-serif" font-size="8" fill="#cc4444">OFFLINE</text></g>';

        svg += '</svg></div>';
        panel.innerHTML = svg;
    }


    // ============ BUILD MODERN UI ============
    function switchModernTab(tabName) {
      document.querySelectorAll('.nav-pill').forEach(function(p) { p.classList.remove('active'); });
      event.target.classList.add('active');
      document.querySelectorAll('.modern-tab-panel').forEach(function(p) { p.style.display = 'none'; });
      var panel = document.getElementById('mtab-' + tabName);
      if (panel) panel.style.display = 'block';
    }

    function buildModernUI() {
      var overlay = document.getElementById('modern-overlay');
      if (overlay) { overlay.style.display = 'block'; return; }
      var sys = networkData.system;
      var devices = sys.devices || [];
      var online = devices.filter(function(d){return d.state===1}).length;
      var offline = devices.filter(function(d){return d.state!==1}).length;
      var aps = devices.filter(function(d){return d.type==='uap'});
      var sws = devices.filter(function(d){return d.type==='usw'});
      var pct = Math.round(online/devices.length*100);
      var circ = 2*Math.PI*20;
      var offset = circ-(pct/100)*circ;

      var h = '<div class="modern-wrapper" id="modern-overlay">';
      // TOP BAR
      h += '<div class="modern-topbar"><div class="logo">NETCMD<span> // FIREWIRE NETWORKS</span></div>';
      h += '<div class="nav-pills">';
      h += '<div class="nav-pill active" onclick="switchModernTab(\'dashboard\')">DASHBOARD</div>';
      h += '<div class="nav-pill" onclick="switchModernTab(\'fleet\')">FLEET</div>';
      h += '<div class="nav-pill" onclick="switchModernTab(\'signals\')">SIGNALS</div>';
      h += '<div class="nav-pill" onclick="switchModernTab(\'defense\')">DEFENSE</div>';
      h += '</div>';
      h += '<div class="status-bar"><div class="status-badge">GATEWAY <span class="sv">' + sys.gateway_model + '</span></div>';
      h += '<div class="status-badge">NODES <span class="sv">' + devices.length + '</span></div>';
      h += '<div class="status-badge">ENDPOINTS <span class="sv">' + (sys.num_clients||0) + '</span></div>';
      h += '<div class="status-badge">HEALTH <span class="sv ' + (offline>0?'warn':'') + '">' + (offline>0?'DEGRADED':'OPTIMAL') + '</span></div></div></div>';

      // CONTENT AREA
      h += '<div class="modern-content"><div class="modern-rail">';
      h += '<div class="rail-card"><div class="rc-label">Total Infrastructure</div><div class="rc-value">' + devices.length + '</div><div class="rc-sub">' + aps.length + ' wireless arrays \u00B7 ' + sws.length + ' core switches</div></div>';
      h += '<div class="rail-card"><div class="rc-label">Systems Active</div><div class="rc-value success">' + online + '</div>';
      h += '<div class="ring-container"><svg class="ring-svg" viewBox="0 0 44 44"><circle class="ring-bg" cx="22" cy="22" r="20"/><circle class="ring-fg" cx="22" cy="22" r="20" stroke-dasharray="' + circ + '" stroke-dashoffset="' + offset + '" transform="rotate(-90 22 22)" style="stroke:' + (offline>0?'#ff6644':'#00ee88') + '"/></svg><span class="ring-label">' + pct + '% operational</span></div></div>';
      h += '<div class="rail-card"><div class="rc-label">Systems Offline</div><div class="rc-value danger">' + offline + '</div><div class="rc-sub">' + (offline>0?'Attention required':'All clear') + '</div></div>';
      h += '<div class="rail-card"><div class="rc-label">Connected Endpoints</div><div class="rc-value info">' + (sys.num_clients||0) + '</div><div class="rc-sub">across ' + aps.filter(function(a){return a.state===1}).length + ' active arrays</div></div>';
      h += '<div class="rail-card"><div class="rc-label">Max Uptime</div><div class="rc-value" style="font-size:22px;color:rgba(192,216,240,.7)">' + formatUptime(Math.max.apply(null,devices.filter(function(d){return d.uptime}).map(function(d){return d.uptime}))) + '</div><div class="rc-sub">most stable node</div></div>';
      h += '<div class="rail-card" style="border-color:rgba(0,238,136,.15)"><div class="rc-label">Network Class</div><div class="rc-value" style="font-size:14px;color:rgba(192,216,240,.6)">' + sys.gateway_model + '</div><div class="rc-sub">cloud-managed infrastructure</div></div>';
      h += '</div><div class="modern-main">';

      // === DASHBOARD TAB ===
      h += '<div class="modern-tab-panel" id="mtab-dashboard" style="display:block">';
      h += '<div class="modern-section">Wireless Arrays</div><div class="holo-grid">';
      aps.forEach(function(d) {
        h += '<div class="holo-card"><div class="hc-header"><div class="hc-icon ' + (d.state===1?'online':'offline') + '">' + (getDeviceImg(d.model)?'<img src="'+getDeviceImg(d.model)+'" style="width:32px;height:32px;object-fit:contain" onerror="this.outerHTML=\'\u1F4E1\'">':'\u1F4E1') + '</div><div><div class="hc-name">' + d.name + '</div><div class="hc-model">' + d.model + '</div></div></div>';
        h += '<div class="hc-status"><div class="dot ' + (d.state===1?'on':'off') + '"></div><span style="color:' + (d.state===1?'#00ee88':'#ff5544') + '">' + (d.state===1?'OPERATIONAL':'OFFLINE') + '</span>';
        if (d.state===1) h += '<span style="color:rgba(192,216,240,.3);margin-left:auto">' + formatUptime(d.uptime) + '</span>';
        h += '</div><div class="hc-details"><div class="hc-detail-item"><div class="hcd-label">MAC</div><div class="hcd-value">' + d.mac + '</div></div><div class="hc-detail-item"><div class="hcd-label">TYPE</div><div class="hcd-value">Access Point</div></div></div></div>';
      });
      h += '</div><div class="modern-section">Core Switches</div><div class="holo-grid">';
      sws.forEach(function(d) {
        h += '<div class="holo-card"><div class="hc-header"><div class="hc-icon ' + (d.state===1?'online':'offline') + '">' + (getDeviceImg(d.model)?'<img src="'+getDeviceImg(d.model)+'" style="width:32px;height:32px;object-fit:contain" onerror="this.outerHTML=\'\u26A1\'">':'\u26A1') + '</div><div><div class="hc-name">' + d.name + '</div><div class="hc-model">' + d.model + '</div></div></div>';
        h += '<div class="hc-status"><div class="dot ' + (d.state===1?'on':'off') + '"></div><span style="color:' + (d.state===1?'#00ee88':'#ff5544') + '">' + (d.state===1?'OPERATIONAL':'OFFLINE') + '</span>';
        if (d.state===1) h += '<span style="color:rgba(192,216,240,.3);margin-left:auto">' + formatUptime(d.uptime) + '</span>';
        h += '</div><div class="hc-details"><div class="hc-detail-item"><div class="hcd-label">MAC</div><div class="hcd-value">' + d.mac + '</div></div><div class="hc-detail-item"><div class="hcd-label">TYPE</div><div class="hcd-value">Switch</div></div></div></div>';
      });
      h += '</div></div>';

      // === FLEET TAB ===
      h += '<div class="modern-tab-panel" id="mtab-fleet" style="display:none">';
      h += '<div class="modern-section">Fleet Registry \u2014 ' + devices.length + ' Nodes</div>';
      h += '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px;font-family:Orbitron,monospace">';
      h += '<thead><tr style="border-bottom:1px solid rgba(0,150,255,.2)">';
      h += '<th style="text-align:left;padding:12px 10px;color:#00aaff;letter-spacing:2px;font-size:9px">STATUS</th>';
      h += '<th style="text-align:left;padding:12px 10px;color:#00aaff;letter-spacing:2px;font-size:9px">DESIGNATION</th>';
      h += '<th style="text-align:left;padding:12px 10px;color:#00aaff;letter-spacing:2px;font-size:9px">CLASS</th>';
      h += '<th style="text-align:left;padding:12px 10px;color:#00aaff;letter-spacing:2px;font-size:9px">MODEL</th>';
      h += '<th style="text-align:left;padding:12px 10px;color:#00aaff;letter-spacing:2px;font-size:9px">MAC ADDRESS</th>';
      h += '<th style="text-align:left;padding:12px 10px;color:#00aaff;letter-spacing:2px;font-size:9px">UPTIME</th>';
      h += '</tr></thead><tbody>';
      devices.forEach(function(d) {
        h += '<tr style="border-bottom:1px solid rgba(0,150,255,.05);transition:all .2s" onmouseenter="this.style.background=\'rgba(0,100,255,.08)\'" onmouseleave="this.style.background=\'transparent\'">';
        h += '<td style="padding:14px 10px"><div style="width:10px;height:10px;border-radius:50%;background:' + (d.state===1?'#00ee88':'#ff5544') + ';box-shadow:0 0 8px ' + (d.state===1?'#00ee88':'#ff5544') + '"></div></td>';
        h += '<td style="padding:14px 10px;color:#fff;font-weight:700;font-size:13px">' + d.name + '</td>';
        h += '<td style="padding:14px 10px;color:rgba(192,216,240,.5)">' + (d.type==='uap'?'Wireless Array':'Core Switch') + '</td>';
        h += '<td style="padding:14px 10px;color:#00aaff">' + d.model + '</td>';
        h += '<td style="padding:14px 10px;color:rgba(192,216,240,.3);font-family:monospace;font-size:11px">' + d.mac + '</td>';
        h += '<td style="padding:14px 10px;color:' + (d.state===1?'#00ee88':'#ff5544') + '">' + (d.state===1?formatUptime(d.uptime):'OFFLINE') + '</td>';
        h += '</tr>';
      });
      h += '</tbody></table></div>';
      h += '<div class="modern-section" style="margin-top:25px">Fleet Distribution</div>';
      h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">';
      h += '<div style="background:rgba(0,238,136,.04);border:1px solid rgba(0,238,136,.15);border-radius:8px;padding:20px;text-align:center"><div style="font-size:9px;letter-spacing:3px;color:rgba(0,238,136,.5);margin-bottom:8px">WIRELESS ARRAYS</div><div style="font-size:42px;font-weight:700;color:#00ee88">' + aps.length + '</div><div style="font-size:10px;color:rgba(192,216,240,.3);margin-top:5px">' + aps.filter(function(a){return a.state===1}).length + ' online / ' + aps.filter(function(a){return a.state!==1}).length + ' offline</div></div>';
      h += '<div style="background:rgba(0,170,255,.04);border:1px solid rgba(0,170,255,.15);border-radius:8px;padding:20px;text-align:center"><div style="font-size:9px;letter-spacing:3px;color:rgba(0,170,255,.5);margin-bottom:8px">CORE SWITCHES</div><div style="font-size:42px;font-weight:700;color:#00aaff">' + sws.length + '</div><div style="font-size:10px;color:rgba(192,216,240,.3);margin-top:5px">' + sws.filter(function(s){return s.state===1}).length + ' online / ' + sws.filter(function(s){return s.state!==1}).length + ' offline</div></div>';
      h += '</div></div>';

      // === SIGNALS TAB ===
      h += '<div class="modern-tab-panel" id="mtab-signals" style="display:none">';
      h += '<div class="modern-section">Real-Time Telemetry</div>';
      h += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px">';
      h += '<div style="background:rgba(0,238,136,.04);border:1px solid rgba(0,238,136,.12);border-radius:10px;padding:20px;text-align:center"><div style="font-size:9px;letter-spacing:3px;color:rgba(0,238,136,.4);margin-bottom:8px">NODES ONLINE</div><div style="font-size:36px;font-weight:700;color:#00ee88">' + online + '<span style="font-size:16px;color:rgba(192,216,240,.3)">/' + devices.length + '</span></div><div style="height:4px;background:rgba(255,255,255,.05);border-radius:2px;margin-top:12px;overflow:hidden"><div style="height:100%;width:' + pct + '%;background:linear-gradient(90deg,#00ee88,#00ccff);border-radius:2px"></div></div></div>';
      h += '<div style="background:rgba(0,170,255,.04);border:1px solid rgba(0,170,255,.12);border-radius:10px;padding:20px;text-align:center"><div style="font-size:9px;letter-spacing:3px;color:rgba(0,170,255,.4);margin-bottom:8px">ACTIVE CLIENTS</div><div style="font-size:36px;font-weight:700;color:#00aaff">' + (sys.num_clients||0) + '</div><div style="height:4px;background:rgba(255,255,255,.05);border-radius:2px;margin-top:12px;overflow:hidden"><div style="height:100%;width:' + Math.min((sys.num_clients||0)*2,100) + '%;background:linear-gradient(90deg,#00aaff,#cc99ff);border-radius:2px"></div></div></div>';
      h += '<div style="background:rgba(255,102,68,.04);border:1px solid rgba(255,102,68,.12);border-radius:10px;padding:20px;text-align:center"><div style="font-size:9px;letter-spacing:3px;color:rgba(255,102,68,.4);margin-bottom:8px">ALERTS</div><div style="font-size:36px;font-weight:700;color:' + (offline>0?'#ff6644':'#00ee88') + '">' + offline + '</div><div style="height:4px;background:rgba(255,255,255,.05);border-radius:2px;margin-top:12px;overflow:hidden"><div style="height:100%;width:' + (offline>0?Math.round(offline/devices.length*100):'0') + '%;background:linear-gradient(90deg,#ff6644,#ff4444);border-radius:2px"></div></div></div>';
      h += '</div>';
      h += '<div class="modern-section">Node Heartbeat</div>';
      h += '<div style="display:grid;grid-template-columns:repeat(' + Math.min(devices.length,8) + ',1fr);gap:8px">';
      devices.forEach(function(d) {
        h += '<div style="background:rgba(0,60,120,.06);border:1px solid rgba(' + (d.state===1?'0,150,255,.12':'255,85,68,.15') + ');border-radius:8px;padding:15px;text-align:center;transition:all .3s">';
        h += '<div style="width:12px;height:12px;border-radius:50%;background:' + (d.state===1?'#00ee88':'#ff5544') + ';margin:0 auto 8px;box-shadow:0 0 10px ' + (d.state===1?'rgba(0,238,136,.5)':'rgba(255,85,68,.5)') + '"></div>';
        h += '<div style="font-size:10px;color:' + (d.state===1?'#fff':'rgba(192,216,240,.3)') + ';font-weight:700;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + d.name + '</div>';
        h += '<div style="font-size:8px;color:rgba(192,216,240,.2);letter-spacing:1px">' + (d.type==='uap'?'AP':'SW') + '</div>';
        h += '</div>';
      });
      h += '</div>';
      h += '<div class="modern-section" style="margin-top:20px">Signal Stream</div>';
      h += '<div id="modern-signal-log" style="background:rgba(0,10,20,.5);border:1px solid rgba(0,150,255,.08);border-radius:8px;padding:15px;font-family:monospace;font-size:11px;height:180px;overflow-y:auto;color:rgba(192,216,240,.3)"></div>';
      h += '</div>';

      // === DEFENSE TAB ===
      h += '<div class="modern-tab-panel" id="mtab-defense" style="display:none">';
      h += '<div class="modern-section">Defense Status</div>';
      h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin-bottom:20px">';
      h += '<div style="background:rgba(255,85,68,.04);border:1px solid rgba(255,85,68,.15);border-radius:10px;padding:20px"><div style="font-size:9px;letter-spacing:3px;color:rgba(255,85,68,.5);margin-bottom:8px">IDS / IPS</div><div style="font-size:18px;font-weight:700;color:#ff6644">UNAVAILABLE</div><div style="font-size:10px;color:rgba(192,216,240,.3);margin-top:5px">Requires local gateway</div></div>';
      h += '<div style="background:rgba(255,170,0,.04);border:1px solid rgba(255,170,0,.15);border-radius:10px;padding:20px"><div style="font-size:9px;letter-spacing:3px;color:rgba(255,170,0,.5);margin-bottom:8px">THREAT LEVEL</div><div style="font-size:18px;font-weight:700;color:#ffaa00">UNKNOWN</div><div style="font-size:10px;color:rgba(192,216,240,.3);margin-top:5px">No sensor data</div></div>';
      h += '<div style="background:rgba(0,238,136,.04);border:1px solid rgba(0,238,136,.15);border-radius:10px;padding:20px"><div style="font-size:9px;letter-spacing:3px;color:rgba(0,238,136,.5);margin-bottom:8px">ENCRYPTION</div><div style="font-size:18px;font-weight:700;color:#00ee88">ACTIVE</div><div style="font-size:10px;color:rgba(192,216,240,.3);margin-top:5px">WPA3/WPA2 enabled</div></div>';
      h += '</div>';
      h += '<div class="modern-section">Threat Intelligence Lookup</div>';
      h += '<div style="background:rgba(0,60,120,.06);border:1px solid rgba(0,150,255,.12);border-radius:10px;padding:25px">';
      h += '<div style="font-size:10px;letter-spacing:3px;color:rgba(192,216,240,.3);margin-bottom:12px">ABUSEIPDB REPUTATION CHECK</div>';
      h += '<div style="display:flex;gap:10px"><input type="text" id="modern-ip-input" placeholder="Enter IP address..." style="flex:1;background:rgba(0,10,20,.5);border:1px solid rgba(0,150,255,.15);border-radius:6px;color:#fff;padding:12px 16px;font-family:Orbitron,monospace;font-size:12px;outline:none;transition:border .3s" onfocus="this.style.borderColor=\'rgba(0,200,255,.4)\'" onblur="this.style.borderColor=\'rgba(0,150,255,.15)\'">';
      h += '<button onclick="modernIpLookup()" style="background:linear-gradient(135deg,rgba(0,100,255,.2),rgba(0,200,255,.1));border:1px solid rgba(0,200,255,.3);color:#00ccff;padding:12px 24px;font-family:Orbitron,sans-serif;font-size:10px;letter-spacing:2px;cursor:pointer;border-radius:6px;transition:all .3s" onmouseenter="this.style.background=\'rgba(0,150,255,.3)\'" onmouseleave="this.style.background=\'linear-gradient(135deg,rgba(0,100,255,.2),rgba(0,200,255,.1))\'">ANALYZE</button></div>';
      h += '<div id="modern-ip-result" style="margin-top:15px"></div></div>';
      h += '<div class="modern-section" style="margin-top:20px">Security Advisory</div>';
      h += '<div style="background:rgba(255,170,0,.04);border:1px solid rgba(255,170,0,.12);border-radius:10px;padding:20px">';
      h += '<div style="font-size:12px;font-weight:700;color:#ffaa00;margin-bottom:8px">\u26A0 Cloud-Hosted Configuration</div>';
      h += '<div style="font-size:12px;color:rgba(192,216,240,.4);line-height:1.6">Your network uses a cloud-managed gateway. For full threat detection capabilities including IDS/IPS, deep packet inspection, GeoIP threat mapping, and real-time intrusion alerts, deploy a UniFi Dream Machine, Cloud Gateway, or UXG appliance.</div></div>';
      h += '<div style="background:rgba(0,170,255,.04);border:1px solid rgba(0,170,255,.12);border-radius:10px;padding:20px;margin-top:12px">';
      h += '<div style="font-size:12px;font-weight:700;color:#00aaff;margin-bottom:8px">Network Hardening Checklist</div>';
      h += '<div style="font-size:12px;color:rgba(192,216,240,.4);line-height:1.8">';
      h += '\u2713 WPA3 / WPA2-Enterprise encryption<br>';
      h += '\u2713 VLAN segmentation for IoT devices<br>';
      h += '\u2713 Guest network isolation<br>';
      h += '\u25CB Deploy local gateway for IDS/IPS<br>';
      h += '\u25CB Enable AbuseIPDB threat intelligence<br>';
      h += '\u25CB Configure automated threat blocking</div></div>';
      h += '</div>';

      h += '</div></div>';

      // FOOTER
      h += '<div class="modern-footer"><div class="mf-dot"></div><span>NETWORK COMMAND INTERFACE v3.0 &nbsp;|&nbsp; M33HAN &nbsp;|&nbsp; STARDATE ' + getStardate() + '</span><span style="margin-left:auto">FIREWIRE NETWORKS LTD</span></div>';
      h += '<button class="modern-back" onclick="closeModern()">\u25C4 MEEHAN MODE</button></div>';
      document.body.insertAdjacentHTML('beforeend', h);

      // Start signal log
      var sigEntries = [
        {c:'#00ee88',m:'Health check: All primary systems nominal'},
        {c:'#00aaff',m:'Wireless signal: optimal across all active arrays'},
        {c:'#ffaa00',m:'Attention: ' + offline + ' node(s) reporting offline status'},
        {c:'#cc99ff',m:'Client association: ' + (sys.num_clients||0) + ' endpoints connected'},
        {c:'#00ccff',m:'PoE budget: within operational parameters'},
        {c:'#ff6644',m:'Offline node detected: requires investigation'},
        {c:'#00ee88',m:'Switch fabric: forwarding tables synchronized'},
        {c:'#00aaff',m:'RSSI levels: good across all coverage zones'}
      ];
      setInterval(function() {
        var log = document.getElementById('modern-signal-log');
        if (!log || log.offsetParent === null) return;
        var e = sigEntries[Math.floor(Math.random()*sigEntries.length)];
        var div = document.createElement('div');
        div.style.color = e.c;
        div.style.marginBottom = '4px';
        div.textContent = '[' + new Date().toLocaleTimeString('en-GB') + '] ' + e.m;
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
        if (log.children.length > 40) log.removeChild(log.firstChild);
      }, 2500);
    }

    function modernIpLookup() {
      var ip = document.getElementById('modern-ip-input').value.trim();
      var result = document.getElementById('modern-ip-result');
      if (!ip) { result.innerHTML = '<div style="color:#ff6644;font-size:11px">Enter an IP address</div>'; return; }
      result.innerHTML = '<div style="color:#00aaff;font-size:11px">Analyzing ' + ip + '...</div>';
      fetch('/threats/api/intel/check/' + ip).then(function(r){return r.json()}).then(function(data) {
        if (data.error) { result.innerHTML = '<div style="color:#ff6644;font-size:12px">' + data.error + '</div>'; return; }
        var riskCol = data.risk_classification==='critical'?'#ff4444':data.risk_classification==='high'?'#ff6644':data.risk_classification==='medium'?'#ffaa00':'#00ee88';
        result.innerHTML = '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:12px">' +
          '<div style="background:rgba(0,60,120,.08);border:1px solid rgba(0,150,255,.1);border-radius:8px;padding:15px"><div style="font-size:9px;letter-spacing:2px;color:rgba(192,216,240,.3);margin-bottom:5px">RISK SCORE</div><div style="font-size:28px;font-weight:700;color:' + riskCol + '">' + (data.abuse_confidence_score||0) + '%</div></div>' +
          '<div style="background:rgba(0,60,120,.08);border:1px solid rgba(0,150,255,.1);border-radius:8px;padding:15px"><div style="font-size:9px;letter-spacing:2px;color:rgba(192,216,240,.3);margin-bottom:5px">ISP</div><div style="font-size:12px;color:#fff">' + (data.isp||'Unknown') + '</div></div>' +
          '<div style="background:rgba(0,60,120,.08);border:1px solid rgba(0,150,255,.1);border-radius:8px;padding:15px"><div style="font-size:9px;letter-spacing:2px;color:rgba(192,216,240,.3);margin-bottom:5px">CLASSIFICATION</div><div style="font-size:14px;font-weight:700;color:' + riskCol + ';text-transform:uppercase">' + (data.risk_classification||'unknown') + '</div></div></div>';
      }).catch(function(e) { result.innerHTML = '<div style="color:#ff6644;font-size:11px">API error: Configure AbuseIPDB key in .env</div>'; });
    }

    function closeModern() {
        var overlay = document.getElementById('modern-overlay');
        if (overlay) overlay.style.display = 'none';
        switchView('overview');
    }

    // ============ INIT ============
    loadData();
    </script>
</body>
</html>
